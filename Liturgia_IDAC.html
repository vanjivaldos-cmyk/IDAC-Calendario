<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liturgia IDAC</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header-logo {
            width: 80px;
            height: auto;
            margin-bottom: 10px;
            filter: drop-shadow(0 4px 15px rgba(255, 215, 0, 0.4));
        }
        .header h1 {
            font-size: 1.8rem;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 5px;
        }
        .header h2 {
            font-size: 1rem;
            color: #a0a0a0;
            font-weight: normal;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        /* Configura√ß√£o do Culto */
        .config-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .config-section h3 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        .config-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .config-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .config-field label {
            color: #a0a0a0;
            font-size: 0.85rem;
        }
        .config-field input,
        .config-field select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1rem;
        }
        .config-field input:focus,
        .config-field select:focus {
            outline: none;
            border-color: #ffd700;
        }
        .config-field select option {
            background: #1a1a2e;
            color: #fff;
        }
        
        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        .toolbar button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn-add { background: #22c55e; color: white; }
        .btn-template { background: #8b5cf6; color: white; }
        .btn-print { background: #3b82f6; color: white; }
        .btn-save { background: #f59e0b; color: white; }
        .btn-clear { background: #ef4444; color: white; }
        .btn-admin { background: #6b7280; color: white; }
        .btn-admin.logged { background: #22c55e; }
        
        .admin-only {
            display: none;
        }
        
        /* Tabela de Liturgia */
        .liturgia-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            overflow: hidden;
        }
        .liturgia-table th {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
            padding: 12px;
            text-align: left;
            font-size: 0.9rem;
        }
        .liturgia-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .liturgia-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        .liturgia-table input,
        .liturgia-table select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.85rem;
        }
        .liturgia-table input:focus,
        .liturgia-table select:focus {
            outline: none;
            border-color: #ffd700;
        }
        .liturgia-table select option {
            background: #1a1a2e;
        }
        .hora-cell {
            font-weight: bold;
            color: #4ecdc4;
            min-width: 70px;
        }
        .duracao-cell {
            width: 80px;
        }
        .duracao-cell input {
            text-align: center;
        }
        .actions-cell {
            width: 50px;
            text-align: center;
        }
        .btn-remove {
            background: #ef4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        /* Resumo */
        .resumo {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
        .resumo-item {
            text-align: center;
        }
        .resumo-item .label {
            color: #a0a0a0;
            font-size: 0.8rem;
        }
        .resumo-item .value {
            color: #ffd700;
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .toast.show {
            display: block;
            animation: fadeIn 0.3s;
        }
        .toast.error {
            background: #ef4444;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        /* Impress√£o */
        @media print {
            @page {
                size: A4 portrait;
                margin: 10mm;
            }
            body {
                background: white !important;
                color: black !important;
                padding: 0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .toolbar, .config-section, .resumo, .actions-cell, .btn-remove {
                display: none !important;
            }
            .header {
                margin-bottom: 15px !important;
            }
            .header h1 {
                color: #1a1a2e !important;
                text-shadow: none !important;
                font-size: 1.4rem !important;
            }
            .header h2 {
                color: #666 !important;
            }
            .header-logo {
                width: 60px !important;
            }
            .culto-info {
                display: block !important;
                text-align: center;
                font-size: 1.2rem;
                font-weight: bold;
                color: #1a1a2e !important;
                margin-bottom: 15px;
                padding: 10px;
                background: #f5f5f5 !important;
                border-radius: 5px;
            }
            .liturgia-table {
                background: white !important;
            }
            .liturgia-table th {
                background: #1a1a2e !important;
                color: white !important;
                padding: 8px !important;
            }
            .liturgia-table td {
                padding: 6px !important;
                border: 1px solid #ccc !important;
            }
            .liturgia-table input,
            .liturgia-table select {
                border: none !important;
                background: transparent !important;
                color: black !important;
                padding: 0 !important;
            }
            .hora-cell {
                color: #1a1a2e !important;
            }
        }
        
        .culto-info {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://raw.githubusercontent.com/vanjivaldos-cmyk/games-idac/main/images/LogoGame.png" alt="Logo IDAC" class="header-logo" onerror="this.style.display='none'">
        <h1>üìã Liturgia IDAC</h1>
        <h2>Igreja de Deus √Åguas Claras</h2>
    </div>

    <div class="container">
        <div class="config-section">
            <h3>‚öôÔ∏è Configura√ß√£o do Culto</h3>
            <div class="config-row">
                <div class="config-field">
                    <label>üìÖ Data</label>
                    <input type="date" id="dataCulto" onchange="updateCultoInfo(); carregarLiturgiaSalva();">
                </div>
                <div class="config-field">
                    <label>‚õ™ Tipo de Culto</label>
                    <select id="tipoCulto" onchange="updateCultoInfo(); carregarLiturgiaSalva();">
                        <option value="Domingo Manh√£">Domingo Manh√£</option>
                        <option value="Domingo Noite" selected>Domingo Noite</option>
                        <option value="Quarta-feira">Quarta-feira</option>
                        <option value="Culto Especial">Culto Especial</option>
                    </select>
                </div>
                <div class="config-field">
                    <label>‚è∞ Hor√°rio In√≠cio</label>
                    <input type="time" id="horaInicio" value="18:00" onchange="recalcularHorarios()">
                </div>
            </div>
        </div>

        <div class="toolbar">
            <button class="btn-add admin-only" onclick="adicionarLinha()">‚ûï Adicionar Item</button>
            <button class="btn-template admin-only" onclick="carregarLiturgiaSalva()">üìÇ Carregar Salvo</button>
            <button class="btn-template admin-only" style="background: #6366f1;" onclick="carregarTemplate()">üìù Novo Template</button>
            <button class="btn-save admin-only" onclick="salvarLiturgia()">üíæ Salvar</button>
            <button class="btn-print" onclick="gerarPDF()">üìÑ Gerar PDF</button>
            <button class="btn-clear admin-only" onclick="limparLiturgia()">üóëÔ∏è Limpar</button>
            <button class="btn-admin" id="adminBtn" onclick="toggleAdmin()">üîê Admin</button>
        </div>

        <div class="culto-info" id="cultoInfo"></div>

        <table class="liturgia-table">
            <thead>
                <tr>
                    <th class="hora-cell">Hora</th>
                    <th>Atividade</th>
                    <th>Respons√°vel</th>
                    <th class="duracao-cell">Dura√ß√£o</th>
                    <th class="actions-cell">üóëÔ∏è</th>
                </tr>
            </thead>
            <tbody id="liturgiaBody">
            </tbody>
        </table>

        <div class="resumo">
            <div class="resumo-item">
                <div class="label">In√≠cio</div>
                <div class="value" id="resumoInicio">--:--</div>
            </div>
            <div class="resumo-item">
                <div class="label">T√©rmino Previsto</div>
                <div class="value" id="resumoTermino">--:--</div>
            </div>
            <div class="resumo-item">
                <div class="label">Dura√ß√£o Total</div>
                <div class="value" id="resumoDuracao">-- min</div>
            </div>
            <div class="resumo-item">
                <div class="label">Itens</div>
                <div class="value" id="resumoItens">0</div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyD_FbMpEZYn_lLZiSjGmP0sMM7XcuTn8Qw",
            authDomain: "games-idac.firebaseapp.com",
            databaseURL: "https://games-idac-default-rtdb.firebaseio.com",
            projectId: "games-idac",
            storageBucket: "games-idac.appspot.com"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const liturgiaRef = database.ref('liturgias');
        const aniversariantesRef = database.ref('aniversariantes');

        // Senha Admin
        const SENHA_ADMIN = 'idac2026';
        let isAdmin = false;

        // Lista de respons√°veis (l√≠deres da IDAC)
        let responsaveis = [
            '',
            '--- PASTORES ---',
            'Bp. Vanjivaldo',
            'Pra. K√©lia',
            'Pra. Nelcy',
            'Pra. Jaqueline',
            'Pra. Miguelina',
            'Pra. Leonilda',
            'Pra. Maria Pereira',
            'Pr. Tadeu',
            'Pr. Dom√≠cio',
            '--- PRESB√çTERO ---',
            'Pb. Jos√©',
            '--- EVANGELISTA ---',
            'Ev. Silvana',
            '--- DI√ÅCONOS ---',
            'Di√°c. Bruno',
            'Di√°c. Junio',
            'Di√°c. Marcos',
            'Diac. Eli Regina',
            'Diac. Eunice',
            'Diac. K√™mille',
            'Diac. Myriam',
            'Diac. Selene',
            '--- MINIST√âRIOS ---',
            'Min. Louvor',
            'Min. KIDS',
            'Min. Teens',
            'Min. Intercess√£o',
            'Min. Mulheres',
            'Min. Homens',
            'M√çDIA',
            'Louvor e Artes',
            '---',
            'Outro...'
        ];
        
        // Atividades padr√£o (templates por tipo de culto)
        const templates = {
            'Domingo Manh√£': [
                { atividade: 'Prel√∫dio Musical com Louvor Multim√≠dia', responsavel: 'M√çDIA', duracao: 5 },
                { atividade: 'Abertura com Sauda√ß√£o aos Presentes', responsavel: '', duracao: 5 },
                { atividade: 'Louvor de Celebra√ß√£o', responsavel: 'Louvor e Artes', duracao: 15 },
                { atividade: 'Momento KIDS', responsavel: 'Min. KIDS', duracao: 5 },
                { atividade: 'Ministra√ß√£o da Palavra', responsavel: '', duracao: 50 },
                { atividade: 'Ofert√≥rio', responsavel: '', duracao: 10 },
                { atividade: 'Reflex√£o Final', responsavel: 'Bp. Vanjivaldo', duracao: 10 },
                { atividade: 'T√©rmino e Ben√ß√£o Apost√≥lica', responsavel: 'Bp. Vanjivaldo', duracao: 5 }
            ],
            'Domingo Noite': [
                { atividade: 'Prel√∫dio Musical com Louvor Multim√≠dia', responsavel: 'M√çDIA', duracao: 5 },
                { atividade: 'Abertura com Sauda√ß√£o aos Presentes', responsavel: 'Pra. Jaqueline', duracao: 2 },
                { atividade: 'Louvor de Celebra√ß√£o', responsavel: 'Min. Louvor', duracao: 20 },
                { atividade: 'Ora√ß√£o pelos enfermos', responsavel: 'Ev. Silvana', duracao: 5 },
                { atividade: 'Avisos da Semana', responsavel: 'Di√°c. Junio', duracao: 10 },
                { atividade: 'Ofert√≥rio', responsavel: 'Pra. Miguelina', duracao: 10 },
                { atividade: 'Momento KIDS', responsavel: 'Di√°c. Bruno', duracao: 5 },
                { atividade: 'Ministra√ß√£o da Palavra', responsavel: 'Bp. Vanjivaldo', duracao: 45 },
                { atividade: 'Momento Convite-Apelo (ora√ß√£o pela semana)', responsavel: 'Pra. Nelcy', duracao: 15 },
                { atividade: 'Ben√ß√£o Apost√≥lica', responsavel: 'Bp. Vanjivaldo', duracao: 10 }
            ],
            'Quarta-feira': [
                { atividade: 'Louvor de Abertura', responsavel: 'Min. Louvor', duracao: 15 },
                { atividade: 'Ora√ß√£o e Intercess√£o', responsavel: 'Min. Intercess√£o', duracao: 20 },
                { atividade: 'Estudo B√≠blico', responsavel: '', duracao: 40 },
                { atividade: 'Avisos', responsavel: '', duracao: 5 },
                { atividade: 'Encerramento', responsavel: '', duracao: 5 }
            ],
            'Culto Especial': [
                { atividade: 'Prel√∫dio Musical', responsavel: 'M√çDIA', duracao: 10 },
                { atividade: 'Abertura', responsavel: '', duracao: 5 },
                { atividade: 'Louvor e Adora√ß√£o', responsavel: 'Min. Louvor', duracao: 30 },
                { atividade: 'Momento Especial', responsavel: '', duracao: 15 },
                { atividade: 'Ministra√ß√£o da Palavra', responsavel: '', duracao: 45 },
                { atividade: 'Ofert√≥rio', responsavel: '', duracao: 10 },
                { atividade: 'Encerramento e Ben√ß√£o', responsavel: 'Bp. Vanjivaldo', duracao: 10 }
            ]
        };

        // Manter compatibilidade com c√≥digo antigo
        const templateDomingoNoite = templates['Domingo Noite'];

        let liturgiaItens = [];

        // Fun√ß√£o para gerar PDF
        function gerarPDF() {
            const data = document.getElementById('dataCulto').value;
            const tipo = document.getElementById('tipoCulto').value;
            const horaInicio = document.getElementById('horaInicio').value;
            
            if (liturgiaItens.length === 0) {
                showToast('Adicione itens √† liturgia primeiro!', true);
                return;
            }
            
            // Formatar data abreviada (dom, 04 de jan de 26)
            const dataObj = new Date(data + 'T12:00:00');
            const diasSemana = ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 's√°b'];
            const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
            const diaSemana = diasSemana[dataObj.getDay()];
            const dia = String(dataObj.getDate()).padStart(2, '0');
            const mes = meses[dataObj.getMonth()];
            const ano = String(dataObj.getFullYear()).slice(-2);
            const dataFormatada = `${diaSemana}, ${dia} de ${mes} de ${ano}`;
            
            // Calcular hor√°rios
            let [horas, minutos] = horaInicio.split(':').map(Number);
            let duracaoTotal = 0;
            
            const linhasHTML = liturgiaItens.map((item, index) => {
                const horaAtual = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
                
                minutos += item.duracao;
                while (minutos >= 60) {
                    minutos -= 60;
                    horas++;
                }
                duracaoTotal += item.duracao;
                
                const bgColor = index % 2 === 0 ? 'rgba(255,255,255,0.05)' : 'rgba(255,255,255,0.02)';
                
                return `
                    <tr style="background: ${bgColor};">
                        <td style="padding: 8px 10px; color: #4ecdc4; font-weight: bold; font-size: 0.85rem;">${horaAtual}</td>
                        <td style="padding: 8px 10px; color: #fff; font-size: 0.85rem;">${item.atividade || '-'}</td>
                        <td style="padding: 8px 10px; color: #a0a0a0; font-size: 0.85rem;">${item.responsavel || '-'}</td>
                        <td style="padding: 8px 10px; color: #ffd700; text-align: center; font-weight: bold; font-size: 0.85rem;">${item.duracao} min</td>
                    </tr>
                `;
            }).join('');
            
            const horaTermino = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
            
            // Criar elemento tempor√°rio para o PDF com visual completo
            const pdfContent = document.createElement('div');
            pdfContent.innerHTML = `
                <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 20px; min-height: 100%; color: #fff;">
                    
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 15px;">
                        <img src="https://raw.githubusercontent.com/vanjivaldos-cmyk/games-idac/main/images/LogoGame.png" 
                             style="width: 60px; height: auto; margin-bottom: 8px; filter: drop-shadow(0 4px 15px rgba(255, 215, 0, 0.4));"
                             crossorigin="anonymous">
                        <h1 style="font-size: 1.4rem; color: #ffd700; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); margin: 5px 0;">üìã Liturgia IDAC</h1>
                        <h2 style="font-size: 0.85rem; color: #a0a0a0; font-weight: normal; margin: 0;">Igreja de Deus √Åguas Claras</h2>
                    </div>
                    
                    <!-- Info do Culto (simplificado) -->
                    <div style="display: flex; justify-content: center; gap: 40px; margin-bottom: 15px; flex-wrap: wrap;">
                        <div style="text-align: center;">
                            <div style="color: #a0a0a0; font-size: 0.7rem;">üìÖ Data</div>
                            <div style="color: #fff; font-size: 0.9rem; font-weight: bold;">${dataFormatada}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #a0a0a0; font-size: 0.7rem;">‚õ™ Culto</div>
                            <div style="color: #fff; font-size: 0.9rem; font-weight: bold;">${tipo}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #a0a0a0; font-size: 0.7rem;">‚è∞ In√≠cio</div>
                            <div style="color: #fff; font-size: 0.9rem; font-weight: bold;">${horaInicio}</div>
                        </div>
                    </div>
                    
                    <!-- Tabela de Liturgia -->
                    <table style="width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.05); border-radius: 10px; overflow: hidden;">
                        <thead>
                            <tr style="background: rgba(255,215,0,0.2);">
                                <th style="padding: 10px 10px; text-align: left; color: #ffd700; font-size: 0.8rem;">Hora</th>
                                <th style="padding: 10px 10px; text-align: left; color: #ffd700; font-size: 0.8rem;">Atividade</th>
                                <th style="padding: 10px 10px; text-align: left; color: #ffd700; font-size: 0.8rem;">Respons√°vel</th>
                                <th style="padding: 10px 10px; text-align: center; color: #ffd700; font-size: 0.8rem;">Dura√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${linhasHTML}
                        </tbody>
                    </table>
                    
                    <!-- Resumo -->
                    <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 12px; margin-top: 15px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px;">
                        <div style="text-align: center;">
                            <div style="color: #a0a0a0; font-size: 0.7rem;">In√≠cio</div>
                            <div style="color: #ffd700; font-size: 1.1rem; font-weight: bold;">${horaInicio}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #a0a0a0; font-size: 0.7rem;">T√©rmino</div>
                            <div style="color: #ffd700; font-size: 1.1rem; font-weight: bold;">${horaTermino}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #a0a0a0; font-size: 0.7rem;">Dura√ß√£o</div>
                            <div style="color: #ffd700; font-size: 1.1rem; font-weight: bold;">${duracaoTotal} min</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #a0a0a0; font-size: 0.7rem;">Itens</div>
                            <div style="color: #ffd700; font-size: 1.1rem; font-weight: bold;">${liturgiaItens.length}</div>
                        </div>
                    </div>
                    
                    <!-- Rodap√© -->
                    <div style="text-align: center; margin-top: 15px; color: #555; font-size: 0.65rem;">
                        Gerado em ${new Date().toLocaleString('pt-BR')} | IDAC
                    </div>
                </div>
            `;
            
            // Configura√ß√µes do PDF
            const opt = {
                margin: [10, 10, 10, 10],
                filename: `Liturgia_IDAC_${data}_${tipo.replace(/\s/g, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#1a1a2e'
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            
            showToast('Gerando PDF...');
            
            html2pdf().set(opt).from(pdfContent).save().then(() => {
                showToast('PDF gerado com sucesso!');
            }).catch(err => {
                showToast('Erro ao gerar PDF: ' + err.message, true);
                console.error(err);
            });
        }

        function gerarLinhasPDF() {
            // Fun√ß√£o n√£o mais usada, mantida para compatibilidade
            return '';
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            // Definir data de hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataCulto').value = hoje;
            updateCultoInfo();
            
            // Carregar respons√°veis adicionados do Firebase
            carregarResponsaveisAdicionados();
            
            // Tentar carregar liturgia salva para hoje
            carregarLiturgiaSalva();
        });

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function toggleAdmin() {
            if (isAdmin) {
                // Logout
                isAdmin = false;
                document.getElementById('adminBtn').innerHTML = 'üîê Admin';
                document.getElementById('adminBtn').classList.remove('logged');
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                showToast('Voc√™ saiu do modo administrador');
                renderizarTabela();
            } else {
                // Login
                const senha = prompt('Digite a senha de administrador:');
                if (senha === SENHA_ADMIN) {
                    isAdmin = true;
                    document.getElementById('adminBtn').innerHTML = 'üîì Admin (Logado)';
                    document.getElementById('adminBtn').classList.add('logged');
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-block');
                    showToast('Acesso de administrador liberado!');
                    renderizarTabela();
                } else if (senha !== null) {
                    showToast('Senha incorreta!', true);
                }
            }
        }

        function updateCultoInfo() {
            const data = document.getElementById('dataCulto').value;
            const tipo = document.getElementById('tipoCulto').value;
            if (data) {
                const dataFormatada = new Date(data + 'T12:00:00').toLocaleDateString('pt-BR', {
                    weekday: 'long',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                document.getElementById('cultoInfo').innerHTML = `üìÖ ${dataFormatada} - ${tipo}`;
            }
        }

        function gerarSelectResponsavel(valorAtual = '', index = null) {
            // Verificar se o valor atual n√£o est√° na lista (foi digitado manualmente)
            const valorNaLista = responsaveis.includes(valorAtual) || valorAtual === '' || valorAtual.startsWith('---');
            
            let options = responsaveis.map(r => {
                if (r === '---' || r.startsWith('---')) {
                    const label = r === '---' ? '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ' : r.replace('---', '').trim();
                    return `<option disabled style="font-weight:bold; color:#ffd700;">‚îÄ‚îÄ ${label} ‚îÄ‚îÄ</option>`;
                }
                return `<option value="${r}" ${r === valorAtual ? 'selected' : ''}>${r || '-- Selecione --'}</option>`;
            }).join('');
            
            // Se o valor atual n√£o est√° na lista, adicionar como op√ß√£o
            if (!valorNaLista && valorAtual) {
                options = `<option value="${valorAtual}" selected>${valorAtual}</option>` + options;
            }
            
            if (index !== null) {
                return `<select onchange="selecionarResponsavel(${index}, this)">${options}</select>`;
            }
            return `<select>${options}</select>`;
        }

        // Lista de respons√°veis adicionados manualmente (tempor√°rios)
        let responsaveisAdicionados = [];

        function selecionarResponsavel(index, selectElement) {
            let valor = selectElement.value;
            
            if (valor === 'Outro...') {
                const novoNome = prompt('Digite o nome do respons√°vel:');
                if (novoNome && novoNome.trim() !== '') {
                    valor = novoNome.trim();
                    
                    // Verificar se j√° existe na lista original ou nos adicionados
                    const jaExiste = responsaveis.includes(valor) || responsaveisAdicionados.includes(valor);
                    
                    if (jaExiste) {
                        showToast(`"${valor}" j√° est√° na lista! Selecione no dropdown.`, true);
                        renderizarTabela();
                        return;
                    }
                    
                    // Adicionar √† lista tempor√°ria
                    responsaveisAdicionados.push(valor);
                    
                    // Inserir na lista principal antes de "Outro..."
                    const outroIndex = responsaveis.indexOf('Outro...');
                    if (outroIndex > -1) {
                        responsaveis.splice(outroIndex, 0, valor);
                    }
                    
                    showToast(`"${valor}" adicionado √† lista!`);
                } else {
                    // Cancelou ou n√£o digitou nada
                    valor = liturgiaItens[index].responsavel || '';
                }
            }
            
            atualizarItem(index, 'responsavel', valor);
            renderizarTabela();
        }

        function adicionarLinha(atividade = '', responsavel = '', duracao = 5) {
            liturgiaItens.push({ atividade, responsavel, duracao });
            renderizarTabela();
        }

        function removerLinha(index) {
            liturgiaItens.splice(index, 1);
            renderizarTabela();
        }

        function renderizarTabela() {
            const tbody = document.getElementById('liturgiaBody');
            const horaInicio = document.getElementById('horaInicio').value;
            let [horas, minutos] = horaInicio.split(':').map(Number);
            
            let html = '';
            let duracaoTotal = 0;

            liturgiaItens.forEach((item, index) => {
                const horaAtual = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
                
                if (isAdmin) {
                    // Modo edi√ß√£o (Admin)
                    html += `
                        <tr>
                            <td class="hora-cell">${horaAtual}</td>
                            <td>
                                <input type="text" value="${item.atividade}" 
                                       onchange="atualizarItem(${index}, 'atividade', this.value)"
                                       placeholder="Nome da atividade">
                            </td>
                            <td>
                                ${gerarSelectResponsavel(item.responsavel, index)}
                            </td>
                            <td class="duracao-cell">
                                <input type="number" value="${item.duracao}" min="1" max="120"
                                       onchange="atualizarItem(${index}, 'duracao', parseInt(this.value) || 5)">
                            </td>
                            <td class="actions-cell">
                                <button class="btn-remove" onclick="removerLinha(${index})">‚úï</button>
                            </td>
                        </tr>
                    `;
                } else {
                    // Modo visualiza√ß√£o (p√∫blico)
                    html += `
                        <tr>
                            <td class="hora-cell">${horaAtual}</td>
                            <td>${item.atividade || '-'}</td>
                            <td>${item.responsavel || '-'}</td>
                            <td class="duracao-cell" style="text-align:center">${item.duracao} min</td>
                            <td class="actions-cell"></td>
                        </tr>
                    `;
                }
                
                // Calcular pr√≥ximo hor√°rio
                minutos += item.duracao;
                while (minutos >= 60) {
                    minutos -= 60;
                    horas++;
                }
                duracaoTotal += item.duracao;
            });

            tbody.innerHTML = html;
            
            // Atualizar resumo
            const horaTermino = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
            document.getElementById('resumoInicio').textContent = horaInicio;
            document.getElementById('resumoTermino').textContent = horaTermino;
            document.getElementById('resumoDuracao').textContent = `${duracaoTotal} min`;
            document.getElementById('resumoItens').textContent = liturgiaItens.length;
        }

        function atualizarItem(index, campo, valor) {
            liturgiaItens[index][campo] = valor;
            if (campo === 'duracao') {
                renderizarTabela(); // Recalcular hor√°rios
            }
        }

        function recalcularHorarios() {
            renderizarTabela();
        }

        function carregarTemplate() {
            const tipo = document.getElementById('tipoCulto').value;
            
            if (liturgiaItens.length > 0) {
                if (!confirm(`Isso vai substituir a liturgia atual por um template de "${tipo}". Continuar?`)) return;
            }
            
            // Buscar template do tipo de culto selecionado
            const template = templates[tipo] || templates['Domingo Noite'];
            liturgiaItens = JSON.parse(JSON.stringify(template));
            liturgiaSalva = null; // Marcar como n√£o salvo
            renderizarTabela();
            showToast(`Template "${tipo}" carregado!`);
        }

        function limparLiturgia() {
            if (liturgiaItens.length === 0) return;
            if (!confirm('Limpar toda a liturgia?')) return;
            liturgiaItens = [];
            renderizarTabela();
            showToast('Liturgia limpa!');
        }

        // Vari√°vel para detectar mudan√ßas
        let liturgiaSalva = null;
        let ultimoSalvamento = null;

        function salvarLiturgia() {
            if (!isAdmin) {
                showToast('Apenas administradores podem salvar!', true);
                return;
            }
            
            const data = document.getElementById('dataCulto').value;
            const tipo = document.getElementById('tipoCulto').value;
            const horaInicio = document.getElementById('horaInicio').value;
            
            if (!data) {
                showToast('Selecione uma data!', true);
                return;
            }
            if (liturgiaItens.length === 0) {
                showToast('Adicione itens √† liturgia!', true);
                return;
            }

            // Verificar se houve mudan√ßa
            const dadosAtuais = JSON.stringify({ horaInicio, itens: liturgiaItens });
            if (liturgiaSalva === dadosAtuais) {
                showToast('Liturgia j√° est√° salva! Nenhuma altera√ß√£o detectada.', true);
                return;
            }

            const chave = `${data}_${tipo.replace(/\s/g, '_')}`;
            const dados = {
                data,
                tipo,
                horaInicio,
                itens: liturgiaItens,
                atualizadoEm: new Date().toISOString()
            };

            liturgiaRef.child(chave).set(dados)
                .then(() => {
                    liturgiaSalva = dadosAtuais;
                    showToast('Liturgia salva com sucesso!');
                    
                    // Salvar respons√°veis adicionados no Firebase
                    if (responsaveisAdicionados.length > 0) {
                        salvarResponsaveisAdicionados();
                    }
                })
                .catch(err => showToast('Erro ao salvar: ' + err.message, true));
        }

        // Salvar respons√°veis adicionados no Firebase
        function salvarResponsaveisAdicionados() {
            const responsaveisRef = database.ref('responsaveis_liturgia');
            responsaveisRef.once('value').then(snapshot => {
                let lista = snapshot.val() || [];
                responsaveisAdicionados.forEach(nome => {
                    if (!lista.includes(nome)) {
                        lista.push(nome);
                    }
                });
                responsaveisRef.set(lista);
            });
        }

        // Carregar respons√°veis adicionados do Firebase
        function carregarResponsaveisAdicionados() {
            const responsaveisRef = database.ref('responsaveis_liturgia');
            responsaveisRef.once('value').then(snapshot => {
                const lista = snapshot.val() || [];
                lista.forEach(nome => {
                    if (!responsaveis.includes(nome)) {
                        const outroIndex = responsaveis.indexOf('Outro...');
                        if (outroIndex > -1) {
                            responsaveis.splice(outroIndex, 0, nome);
                        }
                        responsaveisAdicionados.push(nome);
                    }
                });
                if (lista.length > 0) {
                    console.log('Respons√°veis carregados:', lista.length);
                }
            });
        }

        function carregarLiturgiaSalva() {
            const data = document.getElementById('dataCulto').value;
            const tipo = document.getElementById('tipoCulto').value;
            
            if (!data) return;
            
            const chave = `${data}_${tipo.replace(/\s/g, '_')}`;
            
            liturgiaRef.child(chave).once('value')
                .then(snapshot => {
                    const dados = snapshot.val();
                    if (dados) {
                        liturgiaItens = dados.itens || [];
                        document.getElementById('horaInicio').value = dados.horaInicio || '18:00';
                        
                        // Marcar como salvo para detectar mudan√ßas
                        liturgiaSalva = JSON.stringify({ horaInicio: dados.horaInicio, itens: liturgiaItens });
                        
                        renderizarTabela();
                        showToast('Liturgia carregada!');
                    } else {
                        // N√£o tem liturgia salva para esta data/tipo
                        liturgiaItens = [];
                        liturgiaSalva = null;
                        renderizarTabela();
                    }
                })
                .catch(err => {
                    console.log('Erro ao carregar:', err);
                });
        }
    </script>
</body>
</html>
