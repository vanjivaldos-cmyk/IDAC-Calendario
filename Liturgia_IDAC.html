<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liturgia IDAC</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header-logo {
            width: 80px;
            height: auto;
            margin-bottom: 10px;
            filter: drop-shadow(0 4px 15px rgba(255, 215, 0, 0.4));
        }
        .header h1 {
            font-size: 1.8rem;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 5px;
        }
        .header h2 {
            font-size: 1rem;
            color: #a0a0a0;
            font-weight: normal;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        /* Configura√ß√£o do Culto */
        .config-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .config-section h3 {
            color: #ffd700;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        .config-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .config-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .config-field label {
            color: #a0a0a0;
            font-size: 0.85rem;
        }
        .config-field input,
        .config-field select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1rem;
        }
        .config-field input:focus,
        .config-field select:focus {
            outline: none;
            border-color: #ffd700;
        }
        .config-field select option {
            background: #1a1a2e;
            color: #fff;
        }
        
        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }
        .toolbar button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn-add { background: #22c55e; color: white; }
        .btn-template { background: #8b5cf6; color: white; }
        .btn-print { background: #3b82f6; color: white; }
        .btn-save { background: #f59e0b; color: white; }
        .btn-clear { background: #ef4444; color: white; }
        .btn-admin { background: #6b7280; color: white; }
        .btn-admin.logged { background: #22c55e; }
        
        .admin-only {
            display: none;
        }
        
        /* Tabela de Liturgia */
        .liturgia-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            overflow: hidden;
        }
        .liturgia-table th {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
            padding: 12px;
            text-align: left;
            font-size: 0.9rem;
        }
        .liturgia-table td {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .liturgia-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        .liturgia-table input,
        .liturgia-table select {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.85rem;
        }
        .liturgia-table input:focus,
        .liturgia-table select:focus {
            outline: none;
            border-color: #ffd700;
        }
        .liturgia-table select option {
            background: #1a1a2e;
        }
        .hora-cell {
            font-weight: bold;
            color: #4ecdc4;
            min-width: 70px;
        }
        .duracao-cell {
            width: 80px;
        }
        .duracao-cell input {
            text-align: center;
        }
        .actions-cell {
            width: 50px;
            text-align: center;
        }
        .btn-remove {
            background: #ef4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        /* Resumo */
        .resumo {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
        .resumo-item {
            text-align: center;
        }
        .resumo-item .label {
            color: #a0a0a0;
            font-size: 0.8rem;
        }
        .resumo-item .value {
            color: #ffd700;
            font-size: 1.3rem;
            font-weight: bold;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .toast.show {
            display: block;
            animation: fadeIn 0.3s;
        }
        .toast.error {
            background: #ef4444;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        /* Impress√£o */
        @media print {
            @page {
                size: A4 portrait;
                margin: 10mm;
            }
            body {
                background: white !important;
                color: black !important;
                padding: 0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .toolbar, .config-section, .resumo, .actions-cell, .btn-remove {
                display: none !important;
            }
            .header {
                margin-bottom: 15px !important;
            }
            .header h1 {
                color: #1a1a2e !important;
                text-shadow: none !important;
                font-size: 1.4rem !important;
            }
            .header h2 {
                color: #666 !important;
            }
            .header-logo {
                width: 60px !important;
            }
            .culto-info {
                display: block !important;
                text-align: center;
                font-size: 1.2rem;
                font-weight: bold;
                color: #1a1a2e !important;
                margin-bottom: 15px;
                padding: 10px;
                background: #f5f5f5 !important;
                border-radius: 5px;
            }
            .liturgia-table {
                background: white !important;
            }
            .liturgia-table th {
                background: #1a1a2e !important;
                color: white !important;
                padding: 8px !important;
            }
            .liturgia-table td {
                padding: 6px !important;
                border: 1px solid #ccc !important;
            }
            .liturgia-table input,
            .liturgia-table select {
                border: none !important;
                background: transparent !important;
                color: black !important;
                padding: 0 !important;
            }
            .hora-cell {
                color: #1a1a2e !important;
            }
        }
        
        .culto-info {
            display: none;
        }
        
        /* Modal de Notifica√ß√µes e Contatos */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            padding: 25px;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid rgba(255,215,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .modal-header h2 {
            color: #ffd700;
            font-size: 1.3rem;
        }
        .modal-close {
            background: #ef4444;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        /* Lista de escalados para notificar */
        .escalados-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .escalado-item {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .escalado-info {
            flex: 1;
            min-width: 200px;
        }
        .escalado-nome {
            color: #ffd700;
            font-weight: bold;
            font-size: 1rem;
        }
        .escalado-atividade {
            color: #a0a0a0;
            font-size: 0.85rem;
            margin-top: 3px;
        }
        .escalado-telefone {
            color: #4ecdc4;
            font-size: 0.85rem;
            margin-top: 3px;
        }
        .escalado-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .btn-whatsapp {
            background: #25d366;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-whatsapp:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }
        .btn-whatsapp.enviado {
            background: #22c55e;
        }
        .check-enviado {
            color: #22c55e;
            font-size: 1.2rem;
        }
        
        /* Lista de contatos */
        .contatos-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }
        .contato-item {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px;
            display: grid;
            grid-template-columns: 1fr 180px auto;
            gap: 10px;
            align-items: center;
        }
        .contato-item input {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.9rem;
        }
        .contato-item input:focus {
            outline: none;
            border-color: #ffd700;
        }
        .contato-nome {
            color: #ffd700;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .btn-sync {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .btn-salvar-contatos {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            margin-top: 15px;
            width: 100%;
        }
        
        /* Mensagem template */
        .mensagem-template {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .mensagem-template label {
            color: #a0a0a0;
            font-size: 0.85rem;
            display: block;
            margin-bottom: 8px;
        }
        .mensagem-template textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.9rem;
            resize: vertical;
        }
        .mensagem-template textarea:focus {
            outline: none;
            border-color: #ffd700;
        }
        .variaveis-help {
            color: #a0a0a0;
            font-size: 0.75rem;
            margin-top: 8px;
        }
        .variaveis-help code {
            background: rgba(255,255,255,0.1);
            padding: 2px 5px;
            border-radius: 3px;
            color: #4ecdc4;
        }
        
        /* Bot√µes de a√ß√£o do modal */
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .modal-actions button {
            flex: 1;
            min-width: 150px;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Status sem telefone */
        .sem-telefone {
            color: #ef4444;
            font-size: 0.8rem;
        }
        
        /* Formul√°rio novo contato */
        .novo-contato-form {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .novo-contato-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            align-items: end;
        }
        .novo-contato-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .novo-contato-field label {
            color: #a0a0a0;
            font-size: 0.8rem;
        }
        .novo-contato-field input,
        .novo-contato-field select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.9rem;
        }
        .novo-contato-field input:focus,
        .novo-contato-field select:focus {
            outline: none;
            border-color: #22c55e;
        }
        .novo-contato-field select option {
            background: #1a1a2e;
        }
        .btn-add-contato {
            background: #22c55e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            width: 100%;
        }
        .btn-add-contato:hover {
            background: #16a34a;
        }
        
        /* Bot√£o excluir contato */
        .btn-excluir-contato {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .btn-excluir-contato:hover {
            background: #dc2626;
        }
        
        /* Contador */
        .contador-notificacoes {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        .contador-item {
            text-align: center;
        }
        .contador-item .numero {
            color: #ffd700;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .contador-item .label {
            color: #a0a0a0;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://raw.githubusercontent.com/vanjivaldos-cmyk/games-idac/main/images/LogoGame.png" alt="Logo IDAC" class="header-logo" onerror="this.style.display='none'">
        <h1>üìã Liturgia IDAC</h1>
        <h2>Igreja de Deus √Åguas Claras</h2>
    </div>

    <div class="container">
        <div class="config-section">
            <h3 class="admin-only">‚öôÔ∏è Configura√ß√£o do Culto</h3>
            <div class="config-row">
                <div class="config-field">
                    <label>üìÖ Data</label>
                    <input type="date" id="dataCulto" onchange="updateCultoInfo(); carregarLiturgiaSalva();">
                </div>
                <div class="config-field">
                    <label>‚õ™ Tipo de Culto</label>
                    <select id="tipoCulto" onchange="updateCultoInfo(); carregarLiturgiaSalva();">
                        <option value="Domingo Manh√£">Domingo Manh√£</option>
                        <option value="Domingo Noite" selected>Domingo Noite</option>
                        <option value="Quarta-feira">Quarta-feira</option>
                        <option value="Ceia do Senhor">Ceia do Senhor</option>
                        <option value="Culto Especial">Culto Especial</option>
                    </select>
                </div>
                <div class="config-field admin-only">
                    <label>‚è∞ Hor√°rio In√≠cio</label>
                    <input type="time" id="horaInicio" value="18:00" onchange="recalcularHorarios()">
                </div>
            </div>
        </div>

        <div class="toolbar">
            <button class="btn-add admin-only" onclick="adicionarLinha()">‚ûï Adicionar Item</button>
            <button class="btn-template admin-only" onclick="carregarLiturgiaSalva()">üìÇ Carregar Salvo</button>
            <button class="btn-template admin-only" style="background: #6366f1;" onclick="carregarTemplate()">üìù Novo Template</button>
            <button class="btn-save admin-only" onclick="salvarLiturgia()">üíæ Salvar</button>
            <button class="btn-print" onclick="abrirImpressao()">üñ®Ô∏è Imprimir / PDF</button>
            <button class="btn-template admin-only" style="background: #25d366;" onclick="abrirModalNotificacoes()">üì≤ Notificar</button>
            <button class="btn-template admin-only" style="background: #0ea5e9;" onclick="abrirModalContatos()">üë• Contatos</button>
            <button class="btn-clear admin-only" onclick="limparLiturgia()">üóëÔ∏è Limpar</button>
            <button class="btn-admin" id="adminBtn" onclick="toggleAdmin()">üîê Admin</button>
        </div>

        <div class="culto-info" id="cultoInfo"></div>

        <table class="liturgia-table">
            <thead>
                <tr>
                    <th class="hora-cell">Hora</th>
                    <th>Atividade</th>
                    <th>Respons√°vel</th>
                    <th class="duracao-cell">Dura√ß√£o</th>
                    <th class="actions-cell">üóëÔ∏è</th>
                </tr>
            </thead>
            <tbody id="liturgiaBody">
            </tbody>
        </table>

        <div class="resumo">
            <div class="resumo-item">
                <div class="label">In√≠cio</div>
                <div class="value" id="resumoInicio">--:--</div>
            </div>
            <div class="resumo-item">
                <div class="label">T√©rmino Previsto</div>
                <div class="value" id="resumoTermino">--:--</div>
            </div>
            <div class="resumo-item">
                <div class="label">Dura√ß√£o Total</div>
                <div class="value" id="resumoDuracao">-- min</div>
            </div>
            <div class="resumo-item">
                <div class="label">Itens</div>
                <div class="value" id="resumoItens">0</div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Modal de Notifica√ß√µes WhatsApp -->
    <div class="modal-overlay" id="modalNotificacoes">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì≤ Notificar Escalados via WhatsApp</h2>
                <button class="modal-close" onclick="fecharModal('modalNotificacoes')">√ó</button>
            </div>
            
            <div class="contador-notificacoes">
                <div class="contador-item">
                    <div class="numero" id="totalEscalados">0</div>
                    <div class="label">Escalados</div>
                </div>
                <div class="contador-item">
                    <div class="numero" id="comTelefone">0</div>
                    <div class="label">Com Telefone</div>
                </div>
                <div class="contador-item">
                    <div class="numero" id="jaNotificados">0</div>
                    <div class="label">Notificados</div>
                </div>
            </div>
            
            <div class="mensagem-template">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label>üìù Modelo da Mensagem:</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="tipoMensagemSelect" onchange="carregarTipoMensagem()" style="padding: 5px 10px; border-radius: 5px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2);">
                            <option value="padrao">üìã Escala√ß√£o Padr√£o</option>
                        </select>
                        <button onclick="abrirModalMensagens()" style="background: #8b5cf6; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem;">‚öôÔ∏è Gerenciar</button>
                    </div>
                </div>
                <textarea id="mensagemTemplate">Paz do Senhor, {nome}! [EMOJI_MAOS]

Voc√™ est√° escalado(a) para o culto de *{tipoCulto}* no dia *{data}*:

[EMOJI_LISTA] *{atividade}*
[EMOJI_RELOGIO] Hor√°rio previsto: *{horario}*

Contamos com voc√™! Deus aben√ßoe! [EMOJI_MAOS_CIMA]

*Bispo Vanjivaldo e Pra K√©lia*
_Igreja de Deus √Åguas Claras - IDAC_</textarea>
                <div class="variaveis-help">
                    Vari√°veis: <code>{nome}</code> <code>{tipoCulto}</code> <code>{data}</code> <code>{atividade}</code> <code>{horario}</code>
                </div>
            </div>
            
            <div class="escalados-list" id="escaladosList">
                <!-- Lista preenchida via JavaScript -->
            </div>
            
            <div class="modal-actions">
                <button style="background: #6b7280; color: white;" onclick="limparNotificados()">üîÑ Limpar Marca√ß√µes</button>
                <button style="background: #25d366; color: white;" onclick="notificarProximo()">üì≤ Notificar Pr√≥ximo</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Gerenciamento de Contatos -->
    <div class="modal-overlay" id="modalContatos">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üë• Gerenciar Contatos dos Respons√°veis</h2>
                <button class="modal-close" onclick="fecharModal('modalContatos')">√ó</button>
            </div>
            
            <!-- Formul√°rio para adicionar novo contato -->
            <div class="novo-contato-form" id="novoContatoForm">
                <h4 style="color: #ffd700; margin-bottom: 10px;">‚ûï Adicionar Novo Contato</h4>
                <div class="novo-contato-grid">
                    <div class="novo-contato-field">
                        <label>Nome completo (com t√≠tulo)</label>
                        <input type="text" id="novoContatoNome" placeholder="Ex: Di√°c. Jo√£o Silva">
                    </div>
                    <div class="novo-contato-field">
                        <label>Grupo</label>
                        <select id="novoContatoGrupo">
                            <option value="">-- Selecione --</option>
                            <option value="pastores">Pastores</option>
                            <option value="evangelista">Evangelista</option>
                            <option value="presbitero">Presb√≠tero</option>
                            <option value="diaconos">Di√°conos</option>
                            <option value="ministerios">Minist√©rios</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div class="novo-contato-field">
                        <label>Telefone WhatsApp</label>
                        <input type="tel" id="novoContatoTelefone" placeholder="(61) 99999-9999">
                    </div>
                    <div class="novo-contato-field" style="align-self: end;">
                        <button class="btn-add-contato" onclick="adicionarNovoContato()">‚ûï Adicionar</button>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn-sync" onclick="sincronizarComAniversariantes()">üîÑ Sincronizar com Ministra√ß√µes</button>
                <span style="color: #a0a0a0; font-size: 0.8rem; align-self: center;">Busca telefones do Planejamento de Ministra√ß√µes</span>
            </div>
            
            <div class="contatos-list" id="contatosList">
                <!-- Lista preenchida via JavaScript -->
            </div>
            
            <button class="btn-salvar-contatos" onclick="salvarContatos()">üíæ Salvar Contatos</button>
        </div>
    </div>

    <!-- Modal de Gerenciamento de Tipos de Mensagem -->
    <div class="modal-overlay" id="modalMensagens">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù Gerenciar Modelos de Mensagem</h2>
                <button class="modal-close" onclick="fecharModal('modalMensagens')">√ó</button>
            </div>
            
            <!-- Formul√°rio para adicionar novo tipo de mensagem -->
            <div class="novo-contato-form">
                <h4 style="color: #ffd700; margin-bottom: 10px;">‚ûï Criar Novo Modelo</h4>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div class="novo-contato-field">
                        <label>Nome do Modelo</label>
                        <input type="text" id="novoModeloNome" placeholder="Ex: Lembrete de Ensaio">
                    </div>
                    <div class="novo-contato-field">
                        <label>Texto da Mensagem</label>
                        <textarea id="novoModeloTexto" style="min-height: 120px; width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: #fff; font-size: 0.9rem; resize: vertical;" placeholder="Digite a mensagem usando as vari√°veis dispon√≠veis..."></textarea>
                    </div>
                    <div class="variaveis-help" style="margin-top: -5px;">
                        Vari√°veis dispon√≠veis: <code>{nome}</code> <code>{tipoCulto}</code> <code>{data}</code> <code>{atividade}</code> <code>{horario}</code>
                    </div>
                    <button class="btn-add-contato" onclick="adicionarNovoModelo()">‚ûï Adicionar Modelo</button>
                </div>
            </div>
            
            <h4 style="color: #ffd700; margin: 20px 0 10px;">üìã Modelos Salvos</h4>
            <div class="contatos-list" id="modelosList" style="max-height: 300px;">
                <!-- Lista preenchida via JavaScript -->
            </div>
            
            <button class="btn-salvar-contatos" onclick="salvarModelos()">üíæ Salvar Modelos</button>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyD_FbMpEZYn_lLZiSjGmP0sMM7XcuTn8Qw",
            authDomain: "games-idac.firebaseapp.com",
            databaseURL: "https://games-idac-default-rtdb.firebaseio.com",
            projectId: "games-idac",
            storageBucket: "games-idac.appspot.com"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const liturgiaRef = database.ref('liturgias');
        const aniversariantesRef = database.ref('aniversariantes');

        // Senha Admin
        const SENHA_ADMIN = 'idac2026';
        let isAdmin = false;

        // Lista de respons√°veis (l√≠deres da IDAC) - em ordem alfab√©tica por grupo
        let responsaveis = [
            '',
            '--- PASTORES ---',
            'Bp. Vanjivaldo',
            'Pr. Dom√≠cio',
            'Pr. Tadeu',
            'Pra. Jaqueline',
            'Pra. K√©lia',
            'Pra. Leonilda',
            'Pra. Maria Pereira',
            'Pra. Miguelina',
            'Pra. Nelcy',
            '--- EVANGELISTA ---',
            'Ev. Silvana',
            '--- PRESB√çTERO ---',
            'Pb. Jos√©',
            '--- DI√ÅCONOS ---',
            'Di√°c. Bruno',
            'Di√°c. Eli Regina',
            'Di√°c. Eunice',
            'Di√°c. Fl√°vio',
            'Di√°c. Junio',
            'Di√°c. K√™mille',
            'Di√°c. Marcos',
            'Di√°c. Myriam',
            'Di√°c. Selene',
            '--- MINIST√âRIOS ---',
            'M√≠dia',
            'Min. Homens',
            'Min. Intercess√£o',
            'Min. KIDS',
            'Min. Louvor',
            'Min. Louvor e Artes',
            'Min. Mulheres',
            'Min. Teens',
            '---',
            'Outro...'
        ];
        
        // Atividades padr√£o (templates por tipo de culto)
        const templates = {
            'Domingo Manh√£': [
                { atividade: 'Prel√∫dio Musical com Louvor Multim√≠dia', responsavel: 'M√≠dia', duracao: 5 },
                { atividade: 'Abertura com Sauda√ß√£o aos Presentes', responsavel: '', duracao: 5 },
                { atividade: 'Louvor de Celebra√ß√£o', responsavel: 'Min. Louvor e Artes', duracao: 15 },
                { atividade: 'Momento KIDS', responsavel: 'Min. KIDS', duracao: 5 },
                { atividade: 'Ministra√ß√£o da Palavra', responsavel: '', duracao: 50 },
                { atividade: 'Ofert√≥rio', responsavel: '', duracao: 10 },
                { atividade: 'Reflex√£o Final', responsavel: 'Bp. Vanjivaldo', duracao: 10 },
                { atividade: 'T√©rmino e Ben√ß√£o Apost√≥lica', responsavel: 'Bp. Vanjivaldo', duracao: 5 }
            ],
            'Domingo Noite': [
                { atividade: 'Prel√∫dio Musical com Louvor Multim√≠dia', responsavel: 'M√≠dia', duracao: 5 },
                { atividade: 'Abertura com Sauda√ß√£o aos Presentes', responsavel: 'Pra. Jaqueline', duracao: 2 },
                { atividade: 'Louvor de Celebra√ß√£o', responsavel: 'Min. Louvor', duracao: 20 },
                { atividade: 'Ora√ß√£o pelos enfermos', responsavel: 'Ev. Silvana', duracao: 5 },
                { atividade: 'Avisos da Semana', responsavel: 'Di√°c. Junio', duracao: 10 },
                { atividade: 'Ofert√≥rio', responsavel: 'Pra. Miguelina', duracao: 10 },
                { atividade: 'Momento KIDS', responsavel: 'Di√°c. Bruno', duracao: 5 },
                { atividade: 'Ministra√ß√£o da Palavra', responsavel: 'Bp. Vanjivaldo', duracao: 45 },
                { atividade: 'Momento Convite-Apelo (ora√ß√£o pela semana)', responsavel: 'Pra. Nelcy', duracao: 15 },
                { atividade: 'Ben√ß√£o Apost√≥lica', responsavel: 'Bp. Vanjivaldo', duracao: 10 }
            ],
            'Quarta-feira': [
                { atividade: 'Louvor de Abertura', responsavel: 'Min. Louvor', duracao: 15 },
                { atividade: 'Ora√ß√£o e Intercess√£o', responsavel: 'Min. Intercess√£o', duracao: 20 },
                { atividade: 'Estudo B√≠blico', responsavel: '', duracao: 40 },
                { atividade: 'Avisos', responsavel: '', duracao: 5 },
                { atividade: 'Encerramento', responsavel: '', duracao: 5 }
            ],
            'Ceia do Senhor': [
                { atividade: 'Prel√∫dio Musical', responsavel: 'M√≠dia', duracao: 5 },
                { atividade: 'Abertura', responsavel: '', duracao: 5 },
                { atividade: 'Louvor e Adora√ß√£o', responsavel: 'Min. Louvor', duracao: 20 },
                { atividade: 'Ministra√ß√£o da Palavra', responsavel: 'Bp. Vanjivaldo', duracao: 30 },
                { atividade: 'Celebra√ß√£o da Ceia', responsavel: 'Bp. Vanjivaldo', duracao: 20 },
                { atividade: 'Ofert√≥rio', responsavel: '', duracao: 10 },
                { atividade: 'Ben√ß√£o Apost√≥lica', responsavel: 'Bp. Vanjivaldo', duracao: 5 }
            ],
            'Culto Especial': [
                { atividade: 'Prel√∫dio Musical', responsavel: 'M√≠dia', duracao: 10 },
                { atividade: 'Abertura', responsavel: '', duracao: 5 },
                { atividade: 'Louvor e Adora√ß√£o', responsavel: 'Min. Louvor', duracao: 30 },
                { atividade: 'Momento Especial', responsavel: '', duracao: 15 },
                { atividade: 'Ministra√ß√£o da Palavra', responsavel: '', duracao: 45 },
                { atividade: 'Ofert√≥rio', responsavel: '', duracao: 10 },
                { atividade: 'Encerramento e Ben√ß√£o', responsavel: 'Bp. Vanjivaldo', duracao: 10 }
            ]
        };

        // Manter compatibilidade com c√≥digo antigo
        const templateDomingoNoite = templates['Domingo Noite'];

        let liturgiaItens = [];

        // Fun√ß√£o para gerar PDF
        function gerarPDF() {
            const data = document.getElementById('dataCulto').value;
            const tipo = document.getElementById('tipoCulto').value;
            const horaInicio = document.getElementById('horaInicio').value;
            
            if (liturgiaItens.length === 0) {
                showToast('Adicione itens √† liturgia primeiro!', true);
                return;
            }
            
            // Formatar data abreviada (dom, 04 de jan de 26)
            const dataObj = new Date(data + 'T12:00:00');
            const diasSemana = ['dom', 'seg', 'ter', 'qua', 'qui', 'sex', 's√°b'];
            const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
            const diaSemana = diasSemana[dataObj.getDay()];
            const dia = String(dataObj.getDate()).padStart(2, '0');
            const mes = meses[dataObj.getMonth()];
            const ano = String(dataObj.getFullYear()).slice(-2);
            const dataFormatada = `${diaSemana}, ${dia} de ${mes} de ${ano}`;
            
            // Calcular hor√°rios
            let [horas, minutos] = horaInicio.split(':').map(Number);
            let duracaoTotal = 0;
            
            const linhasHTML = liturgiaItens.map((item, index) => {
                const horaAtual = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
                
                minutos += item.duracao;
                while (minutos >= 60) {
                    minutos -= 60;
                    horas++;
                }
                duracaoTotal += item.duracao;
                
                const bgColor = index % 2 === 0 ? 'rgba(255,255,255,0.05)' : 'transparent';
                
                return `
                    <tr style="background: ${bgColor};">
                        <td style="padding: 8px; color: #4ecdc4; font-weight: bold;">${horaAtual}</td>
                        <td style="padding: 8px; color: #fff;">${item.atividade || '-'}</td>
                        <td style="padding: 8px; color: #ccc;">${item.responsavel || '-'}</td>
                        <td style="padding: 8px; color: #ffd700; text-align: center; font-weight: bold;">${item.duracao} min</td>
                    </tr>
                `;
            }).join('');
            
            const horaTermino = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
            
            // Criar elemento tempor√°rio para o PDF
            const pdfContent = document.createElement('div');
            pdfContent.style.width = '210mm';
            pdfContent.style.padding = '15mm';
            pdfContent.style.backgroundColor = '#1a1a2e';
            pdfContent.style.fontFamily = 'Arial, sans-serif';
            pdfContent.style.color = '#fff';
            
            pdfContent.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="https://raw.githubusercontent.com/vanjivaldos-cmyk/games-idac/main/images/LogoGame.png" 
                         style="width: 50px; height: auto; margin-bottom: 10px;">
                    <h1 style="font-size: 20px; color: #ffd700; margin: 5px 0;">üìã Liturgia IDAC</h1>
                    <p style="font-size: 12px; color: #a0a0a0; margin: 0;">Igreja de Deus √Åguas Claras</p>
                </div>
                
                <div style="text-align: center; margin-bottom: 20px; font-size: 14px;">
                    <span style="margin-right: 30px;">üìÖ ${dataFormatada}</span>
                    <span style="margin-right: 30px;">‚õ™ ${tipo}</span>
                    <span>‚è∞ ${horaInicio}</span>
                </div>
                
                <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                    <thead>
                        <tr style="background: rgba(255,215,0,0.3);">
                            <th style="padding: 8px; text-align: left; color: #ffd700; border-bottom: 2px solid #ffd700;">Hora</th>
                            <th style="padding: 8px; text-align: left; color: #ffd700; border-bottom: 2px solid #ffd700;">Atividade</th>
                            <th style="padding: 8px; text-align: left; color: #ffd700; border-bottom: 2px solid #ffd700;">Respons√°vel</th>
                            <th style="padding: 8px; text-align: center; color: #ffd700; border-bottom: 2px solid #ffd700;">Dura√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${linhasHTML}
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; display: flex; justify-content: space-around; text-align: center;">
                    <div>
                        <div style="font-size: 10px; color: #a0a0a0;">In√≠cio</div>
                        <div style="font-size: 16px; color: #ffd700; font-weight: bold;">${horaInicio}</div>
                    </div>
                    <div>
                        <div style="font-size: 10px; color: #a0a0a0;">T√©rmino</div>
                        <div style="font-size: 16px; color: #ffd700; font-weight: bold;">${horaTermino}</div>
                    </div>
                    <div>
                        <div style="font-size: 10px; color: #a0a0a0;">Dura√ß√£o</div>
                        <div style="font-size: 16px; color: #ffd700; font-weight: bold;">${duracaoTotal} min</div>
                    </div>
                    <div>
                        <div style="font-size: 10px; color: #a0a0a0;">Itens</div>
                        <div style="font-size: 16px; color: #ffd700; font-weight: bold;">${liturgiaItens.length}</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 15px; font-size: 9px; color: #555;">
                    Gerado em ${new Date().toLocaleString('pt-BR')} | IDAC
                </div>
            `;
            
            // Configura√ß√µes do PDF
            const opt = {
                margin: 10,
                filename: `Liturgia_IDAC_${data}_${tipo.replace(/\s/g, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.95 },
                html2canvas: { 
                    scale: 2,
                    backgroundColor: '#1a1a2e'
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            showToast('Gerando PDF...');
            
            html2pdf().set(opt).from(pdfContent).save().then(() => {
                showToast('PDF gerado com sucesso!');
            }).catch(err => {
                showToast('Erro ao gerar PDF: ' + err.message, true);
                console.error(err);
            });
        }

        function gerarLinhasPDF() {
            // Fun√ß√£o n√£o mais usada, mantida para compatibilidade
            return '';
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            // Definir data de hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataCulto').value = hoje;
            updateCultoInfo();
            
            // Carregar respons√°veis adicionados do Firebase
            carregarResponsaveisAdicionados();
            
            // Tentar carregar liturgia salva para hoje
            carregarLiturgiaSalva();
        });

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function abrirImpressao() {
            const data = document.getElementById('dataCulto').value;
            const tipo = document.getElementById('tipoCulto').value;
            
            if (liturgiaItens.length === 0) {
                showToast('Adicione itens √† liturgia primeiro!', true);
                return;
            }
            
            // Salvar antes de abrir impress√£o (se houver mudan√ßas)
            if (isAdmin && liturgiaSalva !== JSON.stringify({ horaInicio: document.getElementById('horaInicio').value, itens: liturgiaItens })) {
                if (confirm('Deseja salvar as altera√ß√µes antes de imprimir?')) {
                    salvarLiturgia();
                }
            }
            
            // Abrir p√°gina de impress√£o
            const url = `Liturgia_Print_IDAC.html`;
            window.open(url, '_blank');
        }

        function toggleAdmin() {
            if (isAdmin) {
                // Logout
                isAdmin = false;
                document.getElementById('adminBtn').innerHTML = 'üîê Admin';
                document.getElementById('adminBtn').classList.remove('logged');
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                showToast('Voc√™ saiu do modo administrador');
                renderizarTabela();
            } else {
                // Login
                const senha = prompt('Digite a senha de administrador:');
                if (senha === SENHA_ADMIN) {
                    isAdmin = true;
                    document.getElementById('adminBtn').innerHTML = 'üîì Admin (Logado)';
                    document.getElementById('adminBtn').classList.add('logged');
                    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-block');
                    showToast('Acesso de administrador liberado!');
                    renderizarTabela();
                } else if (senha !== null) {
                    showToast('Senha incorreta!', true);
                }
            }
        }

        // Hor√°rios padr√£o por tipo de culto
        const horariosPadrao = {
            'Domingo Manh√£': '09:30',
            'Domingo Noite': '17:55',
            'Quarta-feira': '20:00',
            'Culto Especial': '20:00',
            'Ceia do Senhor': '18:00'
        };

        function updateCultoInfo() {
            const data = document.getElementById('dataCulto').value;
            const tipo = document.getElementById('tipoCulto').value;
            
            // Atualizar hor√°rio padr√£o baseado no tipo de culto (s√≥ se n√£o tiver itens)
            if (horariosPadrao[tipo] && liturgiaItens.length === 0) {
                document.getElementById('horaInicio').value = horariosPadrao[tipo];
            }
            
            if (data) {
                const dataFormatada = new Date(data + 'T12:00:00').toLocaleDateString('pt-BR', {
                    weekday: 'long',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                document.getElementById('cultoInfo').innerHTML = `üìÖ ${dataFormatada} - ${tipo}`;
            }
        }

        function gerarSelectResponsavel(valorAtual = '', index = null) {
            // Verificar se o valor atual n√£o est√° na lista (foi digitado manualmente)
            const valorNaLista = responsaveis.includes(valorAtual) || valorAtual === '' || valorAtual.startsWith('---');
            
            let options = responsaveis.map(r => {
                if (r === '---' || r.startsWith('---')) {
                    const label = r === '---' ? '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ' : r.replace('---', '').trim();
                    return `<option disabled style="font-weight:bold; color:#ffd700;">‚îÄ‚îÄ ${label} ‚îÄ‚îÄ</option>`;
                }
                return `<option value="${r}" ${r === valorAtual ? 'selected' : ''}>${r || '-- Selecione --'}</option>`;
            }).join('');
            
            // Se o valor atual n√£o est√° na lista, adicionar como op√ß√£o
            if (!valorNaLista && valorAtual) {
                options = `<option value="${valorAtual}" selected>${valorAtual}</option>` + options;
            }
            
            if (index !== null) {
                return `<select onchange="selecionarResponsavel(${index}, this)">${options}</select>`;
            }
            return `<select>${options}</select>`;
        }

        // Lista de respons√°veis adicionados manualmente (tempor√°rios)
        let responsaveisAdicionados = [];

        // Grupos dispon√≠veis para novos respons√°veis
        const gruposDisponiveis = [
            { id: 'pastores', nome: 'PASTORES', prefixo: 'Pra./Pr.' },
            { id: 'evangelista', nome: 'EVANGELISTA', prefixo: 'Ev.' },
            { id: 'presbitero', nome: 'PRESB√çTERO', prefixo: 'Pb.' },
            { id: 'diaconos', nome: 'DI√ÅCONOS', prefixo: 'Di√°c./Diac.' },
            { id: 'ministerios', nome: 'MINIST√âRIOS', prefixo: '' }
        ];

        function selecionarResponsavel(index, selectElement) {
            let valor = selectElement.value;
            
            if (valor === 'Outro...') {
                // Criar modal para cadastro
                const novoNome = prompt('Digite o nome do respons√°vel (ex: Di√°c. Fl√°vio):');
                if (novoNome && novoNome.trim() !== '') {
                    valor = novoNome.trim();
                    
                    // Verificar se j√° existe na lista
                    const jaExiste = responsaveis.includes(valor);
                    
                    if (jaExiste) {
                        showToast(`"${valor}" j√° est√° na lista! Selecione no dropdown.`, true);
                        renderizarTabela();
                        return;
                    }
                    
                    // Perguntar o grupo
                    const grupoEscolhido = prompt(
                        'Em qual grupo este respons√°vel se enquadra?\n\n' +
                        '1 - PASTORES\n' +
                        '2 - EVANGELISTA\n' +
                        '3 - PRESB√çTERO\n' +
                        '4 - DI√ÅCONOS\n' +
                        '5 - MINIST√âRIOS\n\n' +
                        'Digite o n√∫mero (1-5):'
                    );
                    
                    if (grupoEscolhido) {
                        const grupoIndex = parseInt(grupoEscolhido) - 1;
                        if (grupoIndex >= 0 && grupoIndex < gruposDisponiveis.length) {
                            const grupo = gruposDisponiveis[grupoIndex];
                            
                            // Encontrar posi√ß√£o do grupo na lista
                            const marcadorGrupo = `--- ${grupo.nome} ---`;
                            let posicaoGrupo = responsaveis.indexOf(marcadorGrupo);
                            
                            if (posicaoGrupo > -1) {
                                // Encontrar fim do grupo (pr√≥ximo marcador ou "Outro...")
                                let posicaoFim = posicaoGrupo + 1;
                                while (posicaoFim < responsaveis.length && 
                                       !responsaveis[posicaoFim].startsWith('---') && 
                                       responsaveis[posicaoFim] !== 'Outro...') {
                                    posicaoFim++;
                                }
                                
                                // Inserir no grupo correto (em ordem alfab√©tica)
                                let posicaoInserir = posicaoGrupo + 1;
                                while (posicaoInserir < posicaoFim && 
                                       responsaveis[posicaoInserir].localeCompare(valor) < 0) {
                                    posicaoInserir++;
                                }
                                
                                responsaveis.splice(posicaoInserir, 0, valor);
                                responsaveisAdicionados.push({ nome: valor, grupo: grupo.id });
                                showToast(`"${valor}" adicionado em ${grupo.nome}!`);
                            } else {
                                // Grupo n√£o encontrado, adiciona antes de "Outro..."
                                const outroIndex = responsaveis.indexOf('Outro...');
                                if (outroIndex > -1) {
                                    responsaveis.splice(outroIndex, 0, valor);
                                }
                                responsaveisAdicionados.push({ nome: valor, grupo: grupo.id });
                                showToast(`"${valor}" adicionado!`);
                            }
                        } else {
                            // N√∫mero inv√°lido, adiciona antes de "Outro..."
                            const outroIndex = responsaveis.indexOf('Outro...');
                            if (outroIndex > -1) {
                                responsaveis.splice(outroIndex, 0, valor);
                            }
                            responsaveisAdicionados.push({ nome: valor, grupo: 'outro' });
                            showToast(`"${valor}" adicionado!`);
                        }
                    } else {
                        // Cancelou a escolha do grupo
                        valor = liturgiaItens[index].responsavel || '';
                        renderizarTabela();
                        return;
                    }
                } else {
                    // Cancelou ou n√£o digitou nada
                    valor = liturgiaItens[index].responsavel || '';
                    renderizarTabela();
                    return;
                }
            }
            
            atualizarItem(index, 'responsavel', valor);
            renderizarTabela();
        }

        function adicionarLinha(atividade = '', responsavel = '', duracao = 5) {
            liturgiaItens.push({ atividade, responsavel, duracao });
            renderizarTabela();
        }

        function removerLinha(index) {
            liturgiaItens.splice(index, 1);
            renderizarTabela();
        }

        function renderizarTabela() {
            const tbody = document.getElementById('liturgiaBody');
            const horaInicio = document.getElementById('horaInicio').value;
            let [horas, minutos] = horaInicio.split(':').map(Number);
            
            let html = '';
            let duracaoTotal = 0;

            liturgiaItens.forEach((item, index) => {
                const horaAtual = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
                
                if (isAdmin) {
                    // Modo edi√ß√£o (Admin)
                    html += `
                        <tr>
                            <td class="hora-cell">${horaAtual}</td>
                            <td>
                                <input type="text" value="${item.atividade}" 
                                       onchange="atualizarItem(${index}, 'atividade', this.value)"
                                       placeholder="Nome da atividade">
                            </td>
                            <td>
                                ${gerarSelectResponsavel(item.responsavel, index)}
                            </td>
                            <td class="duracao-cell">
                                <input type="number" value="${item.duracao}" min="1" max="120"
                                       onchange="atualizarItem(${index}, 'duracao', parseInt(this.value) || 5)">
                            </td>
                            <td class="actions-cell">
                                <button class="btn-remove" onclick="removerLinha(${index})">‚úï</button>
                            </td>
                        </tr>
                    `;
                } else {
                    // Modo visualiza√ß√£o (p√∫blico)
                    html += `
                        <tr>
                            <td class="hora-cell">${horaAtual}</td>
                            <td>${item.atividade || '-'}</td>
                            <td>${item.responsavel || '-'}</td>
                            <td class="duracao-cell" style="text-align:center">${item.duracao} min</td>
                            <td class="actions-cell"></td>
                        </tr>
                    `;
                }
                
                // Calcular pr√≥ximo hor√°rio
                minutos += item.duracao;
                while (minutos >= 60) {
                    minutos -= 60;
                    horas++;
                }
                duracaoTotal += item.duracao;
            });

            tbody.innerHTML = html;
            
            // Atualizar resumo
            const horaTermino = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
            document.getElementById('resumoInicio').textContent = horaInicio;
            document.getElementById('resumoTermino').textContent = horaTermino;
            document.getElementById('resumoDuracao').textContent = `${duracaoTotal} min`;
            document.getElementById('resumoItens').textContent = liturgiaItens.length;
        }

        function atualizarItem(index, campo, valor) {
            liturgiaItens[index][campo] = valor;
            if (campo === 'duracao') {
                renderizarTabela(); // Recalcular hor√°rios
            }
        }

        function recalcularHorarios() {
            renderizarTabela();
        }

        function carregarTemplate() {
            const tipo = document.getElementById('tipoCulto').value;
            
            if (liturgiaItens.length > 0) {
                if (!confirm(`Isso vai substituir a liturgia atual por um template de "${tipo}". Continuar?`)) return;
            }
            
            // Buscar template do tipo de culto selecionado
            const template = templates[tipo] || templates['Domingo Noite'];
            liturgiaItens = JSON.parse(JSON.stringify(template));
            liturgiaSalva = null; // Marcar como n√£o salvo
            renderizarTabela();
            showToast(`Template "${tipo}" carregado!`);
        }

        function limparLiturgia() {
            if (liturgiaItens.length === 0) return;
            if (!confirm('Limpar toda a liturgia?')) return;
            liturgiaItens = [];
            renderizarTabela();
            showToast('Liturgia limpa!');
        }

        // Vari√°vel para detectar mudan√ßas
        let liturgiaSalva = null;
        let ultimoSalvamento = null;

        function salvarLiturgia() {
            if (!isAdmin) {
                showToast('Apenas administradores podem salvar!', true);
                return;
            }
            
            const data = document.getElementById('dataCulto').value;
            const tipo = document.getElementById('tipoCulto').value;
            const horaInicio = document.getElementById('horaInicio').value;
            
            if (!data) {
                showToast('Selecione uma data!', true);
                return;
            }
            if (liturgiaItens.length === 0) {
                showToast('Adicione itens √† liturgia!', true);
                return;
            }

            // Verificar se houve mudan√ßa
            const dadosAtuais = JSON.stringify({ horaInicio, itens: liturgiaItens });
            if (liturgiaSalva === dadosAtuais) {
                showToast('Liturgia j√° est√° salva! Nenhuma altera√ß√£o detectada.', true);
                return;
            }

            const chave = `${data}_${tipo.replace(/\s/g, '_')}`;
            const dados = {
                data,
                tipo,
                horaInicio,
                itens: liturgiaItens,
                atualizadoEm: new Date().toISOString()
            };

            liturgiaRef.child(chave).set(dados)
                .then(() => {
                    liturgiaSalva = dadosAtuais;
                    showToast('Liturgia salva com sucesso!');
                    
                    // Salvar respons√°veis adicionados no Firebase
                    if (responsaveisAdicionados.length > 0) {
                        salvarResponsaveisAdicionados();
                    }
                })
                .catch(err => showToast('Erro ao salvar: ' + err.message, true));
        }

        // Salvar respons√°veis adicionados no Firebase
        function salvarResponsaveisAdicionados() {
            const responsaveisRef = database.ref('responsaveis_liturgia');
            responsaveisRef.once('value').then(snapshot => {
                let lista = snapshot.val() || [];
                responsaveisAdicionados.forEach(item => {
                    // Verificar se √© objeto (novo formato) ou string (formato antigo)
                    const nome = typeof item === 'object' ? item.nome : item;
                    const grupo = typeof item === 'object' ? item.grupo : 'outro';
                    
                    // Verificar se j√° existe
                    const existe = lista.some(r => {
                        const nomeExistente = typeof r === 'object' ? r.nome : r;
                        return nomeExistente === nome;
                    });
                    
                    if (!existe) {
                        lista.push({ nome, grupo });
                    }
                });
                responsaveisRef.set(lista);
            });
        }

        // Carregar respons√°veis adicionados do Firebase
        function carregarResponsaveisAdicionados() {
            const responsaveisRef = database.ref('responsaveis_liturgia');
            responsaveisRef.once('value').then(snapshot => {
                const lista = snapshot.val() || [];
                lista.forEach(item => {
                    const nome = typeof item === 'object' ? item.nome : item;
                    const grupo = typeof item === 'object' ? item.grupo : 'outro';
                    
                    if (!responsaveis.includes(nome)) {
                        // Encontrar posi√ß√£o do grupo
                        const grupoInfo = gruposDisponiveis.find(g => g.id === grupo);
                        if (grupoInfo) {
                            const marcadorGrupo = `--- ${grupoInfo.nome} ---`;
                            let posicaoGrupo = responsaveis.indexOf(marcadorGrupo);
                            
                            if (posicaoGrupo > -1) {
                                // Encontrar fim do grupo
                                let posicaoFim = posicaoGrupo + 1;
                                while (posicaoFim < responsaveis.length && 
                                       !responsaveis[posicaoFim].startsWith('---') && 
                                       responsaveis[posicaoFim] !== 'Outro...') {
                                    posicaoFim++;
                                }
                                
                                // Inserir em ordem alfab√©tica
                                let posicaoInserir = posicaoGrupo + 1;
                                while (posicaoInserir < posicaoFim && 
                                       responsaveis[posicaoInserir].localeCompare(nome) < 0) {
                                    posicaoInserir++;
                                }
                                
                                responsaveis.splice(posicaoInserir, 0, nome);
                            } else {
                                // Grupo n√£o encontrado, adiciona antes de "Outro..."
                                const outroIndex = responsaveis.indexOf('Outro...');
                                if (outroIndex > -1) {
                                    responsaveis.splice(outroIndex, 0, nome);
                                }
                            }
                        } else {
                            // Grupo desconhecido, adiciona antes de "Outro..."
                            const outroIndex = responsaveis.indexOf('Outro...');
                            if (outroIndex > -1) {
                                responsaveis.splice(outroIndex, 0, nome);
                            }
                        }
                    }
                });
                if (lista.length > 0) {
                    console.log('Respons√°veis carregados:', lista.length);
                }
            }).catch(err => {
                console.log('Erro ao carregar respons√°veis:', err);
            });
        }

        function carregarLiturgiaSalva() {
            const data = document.getElementById('dataCulto').value;
            const tipo = document.getElementById('tipoCulto').value;
            
            if (!data) return;
            
            const chave = `${data}_${tipo.replace(/\s/g, '_')}`;
            
            liturgiaRef.child(chave).once('value')
                .then(snapshot => {
                    const dados = snapshot.val();
                    if (dados) {
                        liturgiaItens = dados.itens || [];
                        document.getElementById('horaInicio').value = dados.horaInicio || '18:00';
                        
                        // Adicionar respons√°veis dos itens √† lista (se n√£o existirem)
                        liturgiaItens.forEach(item => {
                            if (item.responsavel && !responsaveis.includes(item.responsavel)) {
                                const outroIndex = responsaveis.indexOf('Outro...');
                                if (outroIndex > -1) {
                                    responsaveis.splice(outroIndex, 0, item.responsavel);
                                }
                            }
                        });
                        
                        // Marcar como salvo para detectar mudan√ßas
                        liturgiaSalva = JSON.stringify({ horaInicio: dados.horaInicio, itens: liturgiaItens });
                        
                        renderizarTabela();
                        showToast('Liturgia carregada!');
                    } else {
                        // N√£o tem liturgia salva para esta data/tipo
                        liturgiaItens = [];
                        liturgiaSalva = null;
                        renderizarTabela();
                    }
                })
                .catch(err => {
                    console.log('Erro ao carregar:', err);
                });
        }

        // ========================================
        // SISTEMA DE NOTIFICA√á√ïES WHATSAPP
        // ========================================
        
        // Cadastro de contatos padr√£o (nome -> telefone)
        const contatosPadrao = {
            'Bp. Vanjivaldo': '61984945302',
            'Di√°c. Bruno': '61982593963',
            'Di√°c. Eli Regina': '61998786419',
            'Di√°c. Eunice': '61996636388',
            'Di√°c. Fl√°vio': '61982603507',
            'Di√°c. Junio': '61983395790',
            'Di√°c. K√™mille': '61981770117',
            'Di√°c. Marcos': '61981547869',
            'Di√°c. Myriam': '61981234192',
            'Di√°c. Selene': '61996757007',
            'Ev. Silvana': '61981722189',
            'Pb. Jos√©': '62981393566',
            'Pr. Dom√≠cio': '61982128102',
            'Pr. Jos√© Louren√ßo': '61983351186',
            'Pr. Tadeu': '61995103759',
            'Pra. Domingas': '61983838084',
            'Pra. Jaqueline': '61996618562',
            'Pra. K√©lia': '61985141597',
            'Pra. Leonilda': '62985898548',
            'Pra. Maria Pereira': '61999938730',
            'Pra. Miguelina': '61982130960',
            'Pra. Nelcy': '61991150398'
        };
        
        // Cadastro de contatos (nome -> telefone)
        let contatosResponsaveis = {};
        let ministrantesCache = []; // Cache do Planejamento de Ministra√ß√µes
        let notificadosHoje = {}; // Controle de quem j√° foi notificado
        
        // Refer√™ncia Firebase para contatos
        const contatosRef = database.ref('contatos_responsaveis');
        const ministrantesRef = database.ref('escala/pessoas');
        
        // Carregar contatos do Firebase ao iniciar
        function carregarContatos() {
            // Primeiro carrega os contatos salvos
            contatosRef.once('value').then(snapshot => {
                const contatosSalvos = snapshot.val() || {};
                
                // Mesclar contatos padr√£o com salvos (salvos t√™m prioridade)
                contatosResponsaveis = { ...contatosPadrao, ...contatosSalvos };
                
                console.log('Contatos carregados:', Object.keys(contatosResponsaveis).length);
                
                // Se n√£o tinha nada salvo, salvar os padr√£o
                if (Object.keys(contatosSalvos).length === 0) {
                    contatosRef.set(contatosPadrao).then(() => {
                        console.log('Contatos padr√£o salvos no Firebase');
                    });
                }
                
                // Depois carrega os ministrantes
                carregarMinistrantes();
            }).catch(err => {
                console.log('Erro ao carregar contatos:', err);
                // Usar contatos padr√£o em caso de erro
                contatosResponsaveis = { ...contatosPadrao };
                carregarMinistrantes();
            });
        }
        
        // Carregar ministrantes do Planejamento de Ministra√ß√µes
        function carregarMinistrantes() {
            ministrantesRef.once('value').then(snapshot => {
                ministrantesCache = snapshot.val() || [];
                console.log('Ministrantes carregados:', ministrantesCache.length);
                
                // Mesclar telefones dos ministrantes com contatos
                mesclarTelefonesMinistrantes();
            }).catch(err => {
                console.log('Erro ao carregar ministrantes:', err);
            });
        }
        
        // Mesclar telefones dos ministrantes com contatos existentes
        function mesclarTelefonesMinistrantes() {
            if (!ministrantesCache || ministrantesCache.length === 0) return;
            
            let novosContatos = 0;
            
            // Para cada respons√°vel da lista, tentar encontrar telefone nos ministrantes
            responsaveis.forEach(nomeResponsavel => {
                if (!nomeResponsavel || nomeResponsavel.startsWith('---') || nomeResponsavel === 'Outro...' || nomeResponsavel === '') return;
                
                // Se j√° tem telefone cadastrado, pular
                if (contatosResponsaveis[nomeResponsavel]) return;
                
                // Buscar nos ministrantes
                const telefone = buscarTelefoneMinistrante(nomeResponsavel);
                if (telefone) {
                    contatosResponsaveis[nomeResponsavel] = telefone;
                    novosContatos++;
                }
            });
            
            if (novosContatos > 0) {
                console.log(`${novosContatos} telefones encontrados nos ministrantes`);
            }
        }
        
        // Extrair primeiro nome (sem prefixos)
        function extrairPrimeiroNome(nome) {
            if (!nome) return '';
            // Remove prefixos comuns
            const semPrefixo = nome
                .replace(/^(Bp\.|Pr\.|Pra\.|Pb\.|Ev\.|Di√°c\.|Diac\.|Min\.|M√≠dia|Prof\.)\s*/i, '')
                .trim();
            // Pega s√≥ o primeiro nome
            return semPrefixo.split(' ')[0].toUpperCase();
        }
        
        // Buscar telefone espec√≠fico nos ministrantes (Planejamento de Ministra√ß√µes)
        function buscarTelefoneMinistrante(nomeResponsavel) {
            if (!ministrantesCache || ministrantesCache.length === 0) return null;
            
            const primeiroNome = extrairPrimeiroNome(nomeResponsavel);
            if (!primeiroNome) return null;
            
            // Busca pelo primeiro nome ou nome completo
            const ministrante = ministrantesCache.find(m => {
                if (!m || !m.nome) return false;
                const nomeMinistrante = m.nome.toUpperCase().trim();
                const primeiroNomeMin = extrairPrimeiroNome(m.nome);
                
                // Busca exata pelo nome do ministrante
                if (nomeMinistrante === nomeResponsavel.toUpperCase()) return true;
                
                // Busca pelo primeiro nome
                return primeiroNomeMin === primeiroNome;
            });
            
            return ministrante?.telefone || null;
        }
        
        // Carregar contatos ao iniciar
        carregarContatos();
        
        // Abrir modal de notifica√ß√µes
        function abrirModalNotificacoes() {
            if (!isAdmin) {
                showToast('Apenas administradores podem notificar!', true);
                return;
            }
            
            if (liturgiaItens.length === 0) {
                showToast('Carregue uma liturgia primeiro!', true);
                return;
            }
            
            renderizarListaEscalados();
            document.getElementById('modalNotificacoes').classList.add('active');
        }
        
        // Abrir modal de contatos
        function abrirModalContatos() {
            if (!isAdmin) {
                showToast('Apenas administradores podem gerenciar contatos!', true);
                return;
            }
            
            renderizarListaContatos();
            document.getElementById('modalContatos').classList.add('active');
        }
        
        // Fechar modal
        function fecharModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Fechar modal ao clicar fora
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
        
        // Normalizar nome para busca (remove prefixos como Di√°c., Pra., etc)
        function normalizarNome(nome) {
            if (!nome) return '';
            // Remove prefixos comuns
            return nome
                .replace(/^(Bp\.|Pr\.|Pra\.|Pb\.|Ev\.|Di√°c\.|Diac\.|Min\.|M√≠dia)\s*/i, '')
                .trim()
                .toUpperCase();
        }
        
        // Buscar telefone de um respons√°vel
        function buscarTelefone(nomeResponsavel) {
            if (!nomeResponsavel) return null;
            
            // Primeiro, busca exata no cadastro de contatos
            if (contatosResponsaveis[nomeResponsavel]) {
                return contatosResponsaveis[nomeResponsavel];
            }
            
            // Busca pelo primeiro nome nos contatos
            const primeiroNome = extrairPrimeiroNome(nomeResponsavel);
            for (const [nome, telefone] of Object.entries(contatosResponsaveis)) {
                if (extrairPrimeiroNome(nome) === primeiroNome) {
                    return telefone;
                }
            }
            
            // Se n√£o encontrou nos contatos, buscar nos ministrantes
            const telefoneMin = buscarTelefoneMinistrante(nomeResponsavel);
            if (telefoneMin) {
                // Salvar no cache local para pr√≥ximas buscas
                contatosResponsaveis[nomeResponsavel] = telefoneMin;
                return telefoneMin;
            }
            
            return null;
        }
        
        // Renderizar lista de escalados para notifica√ß√£o
        function renderizarListaEscalados() {
            const container = document.getElementById('escaladosList');
            const data = document.getElementById('dataCulto').value;
            const tipo = document.getElementById('tipoCulto').value;
            const horaInicio = document.getElementById('horaInicio').value;
            
            // Agrupar por respons√°vel (evitar duplicatas)
            const escaladosMap = {};
            let [horas, minutos] = horaInicio.split(':').map(Number);
            
            liturgiaItens.forEach((item, index) => {
                if (item.responsavel && !item.responsavel.startsWith('---') && item.responsavel !== 'Outro...') {
                    const horaAtual = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
                    
                    if (!escaladosMap[item.responsavel]) {
                        escaladosMap[item.responsavel] = {
                            nome: item.responsavel,
                            atividades: [],
                            horarios: [],
                            telefone: buscarTelefone(item.responsavel)
                        };
                    }
                    escaladosMap[item.responsavel].atividades.push(item.atividade);
                    escaladosMap[item.responsavel].horarios.push(horaAtual);
                }
                
                minutos += item.duracao || 0;
                while (minutos >= 60) {
                    minutos -= 60;
                    horas++;
                }
            });
            
            const escalados = Object.values(escaladosMap);
            
            // Atualizar contadores
            const comTelefone = escalados.filter(e => e.telefone).length;
            const chaveNotificacao = `${data}_${tipo}`;
            const notificados = Object.keys(notificadosHoje[chaveNotificacao] || {}).length;
            
            document.getElementById('totalEscalados').textContent = escalados.length;
            document.getElementById('comTelefone').textContent = comTelefone;
            document.getElementById('jaNotificados').textContent = notificados;
            
            // Renderizar lista
            if (escalados.length === 0) {
                container.innerHTML = '<p style="color: #a0a0a0; text-align: center;">Nenhum respons√°vel escalado na liturgia.</p>';
                return;
            }
            
            container.innerHTML = escalados.map(escalado => {
                const foiNotificado = notificadosHoje[chaveNotificacao]?.[escalado.nome];
                const temTelefone = !!escalado.telefone;
                
                return `
                    <div class="escalado-item">
                        <div class="escalado-info">
                            <div class="escalado-nome">${escalado.nome}</div>
                            <div class="escalado-atividade">
                                ${escalado.atividades.map((a, i) => `${escalado.horarios[i]} - ${a}`).join('<br>')}
                            </div>
                            ${temTelefone 
                                ? `<div class="escalado-telefone">üì± ${formatarTelefone(escalado.telefone)}</div>`
                                : `<div class="sem-telefone">‚ö†Ô∏è Sem telefone cadastrado</div>`
                            }
                        </div>
                        <div class="escalado-actions">
                            ${foiNotificado ? '<span class="check-enviado">‚úì</span>' : ''}
                            <button class="btn-whatsapp ${foiNotificado ? 'enviado' : ''}" 
                                    onclick="notificarPessoa('${escalado.nome.replace(/'/g, "\\'")}')"
                                    ${!temTelefone ? 'disabled' : ''}>
                                ${foiNotificado ? '‚úì Enviado' : 'üì≤ WhatsApp'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Formatar telefone para exibi√ß√£o
        function formatarTelefone(telefone) {
            if (!telefone) return '';
            const nums = telefone.replace(/\D/g, '');
            if (nums.length === 11) {
                return `(${nums.slice(0,2)}) ${nums.slice(2,7)}-${nums.slice(7)}`;
            }
            return telefone;
        }
        
        // Formatar telefone para WhatsApp (apenas n√∫meros com c√≥digo do pa√≠s)
        function formatarTelefoneWhatsApp(telefone) {
            if (!telefone) return null;
            let nums = telefone.replace(/\D/g, '');
            // Adicionar c√≥digo do Brasil se n√£o tiver
            if (nums.length === 11) {
                nums = '55' + nums;
            } else if (nums.length === 10) {
                nums = '55' + nums;
            }
            return nums;
        }
        
        // Gerar mensagem personalizada
        function gerarMensagem(nomeResponsavel) {
            const template = document.getElementById('mensagemTemplate').value;
            const data = document.getElementById('dataCulto').value;
            const tipo = document.getElementById('tipoCulto').value;
            const horaInicio = document.getElementById('horaInicio').value;
            
            // Buscar atividades do respons√°vel
            let atividades = [];
            let horarios = [];
            let [horas, minutos] = horaInicio.split(':').map(Number);
            
            liturgiaItens.forEach(item => {
                const horaAtual = `${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
                
                if (item.responsavel === nomeResponsavel) {
                    atividades.push(item.atividade);
                    horarios.push(horaAtual);
                }
                
                minutos += item.duracao || 0;
                while (minutos >= 60) {
                    minutos -= 60;
                    horas++;
                }
            });
            
            // Formatar data
            const dataObj = new Date(data + 'T12:00:00');
            const dataFormatada = dataObj.toLocaleDateString('pt-BR', {
                weekday: 'long',
                day: '2-digit',
                month: 'long'
            });
            
            // Extrair t√≠tulo e primeiro nome
            // Ex: "Pra. Jaqueline" -> "Pra. Jaqueline"
            // Ex: "Di√°c. Bruno" -> "Di√°c. Bruno"
            let nomeComTitulo = nomeResponsavel;
            
            // Se o nome completo tem mais de 2 partes (t√≠tulo + nome + sobrenome), pegar s√≥ t√≠tulo + primeiro nome
            const partes = nomeResponsavel.split(' ');
            if (partes.length > 2) {
                // Verificar se primeira parte √© t√≠tulo
                const titulos = ['Bp.', 'Pr.', 'Pra.', 'Pb.', 'Ev.', 'Di√°c.', 'Diac.', 'Min.', 'Prof.'];
                if (titulos.some(t => partes[0].toLowerCase() === t.toLowerCase())) {
                    nomeComTitulo = `${partes[0]} ${partes[1]}`;
                } else {
                    nomeComTitulo = partes[0]; // S√≥ primeiro nome
                }
            }
            
            // Formatar atividades
            const atividadesFormatadas = atividades.map((a, i) => `‚Ä¢ ${horarios[i]} - ${a}`).join('\n');
            
            // Substituir vari√°veis
            let mensagem = template
                .replace(/{nome}/g, nomeComTitulo)
                .replace(/{tipoCulto}/g, tipo)
                .replace(/{data}/g, dataFormatada)
                .replace(/{atividade}/g, atividadesFormatadas)
                .replace(/{horario}/g, horarios[0] || horaInicio);
            
            // Substituir placeholders por emojis Unicode
            mensagem = mensagem
                .replace(/\[EMOJI_MAOS\]/g, '\u{1F64F}')
                .replace(/\[EMOJI_LISTA\]/g, '\u{1F4CB}')
                .replace(/\[EMOJI_RELOGIO\]/g, '\u23F0')
                .replace(/\[EMOJI_MAOS_CIMA\]/g, '\u{1F64C}');
            
            return mensagem;
        }
        
        // Notificar uma pessoa espec√≠fica
        function notificarPessoa(nomeResponsavel) {
            const telefone = buscarTelefone(nomeResponsavel);
            
            if (!telefone) {
                showToast(`Telefone n√£o cadastrado para ${nomeResponsavel}`, true);
                return;
            }
            
            const mensagem = gerarMensagem(nomeResponsavel);
            const telefoneFormatado = formatarTelefoneWhatsApp(telefone);
            
            // Abrir WhatsApp
            const url = `https://wa.me/${telefoneFormatado}?text=${encodeURIComponent(mensagem)}`;
            window.open(url, '_blank');
            
            // Marcar como notificado
            const data = document.getElementById('dataCulto').value;
            const tipo = document.getElementById('tipoCulto').value;
            const chave = `${data}_${tipo}`;
            
            if (!notificadosHoje[chave]) {
                notificadosHoje[chave] = {};
            }
            notificadosHoje[chave][nomeResponsavel] = true;
            
            // Atualizar lista
            setTimeout(() => renderizarListaEscalados(), 500);
        }
        
        // Notificar pr√≥ximo n√£o notificado
        function notificarProximo() {
            const data = document.getElementById('dataCulto').value;
            const tipo = document.getElementById('tipoCulto').value;
            const chave = `${data}_${tipo}`;
            const horaInicio = document.getElementById('horaInicio').value;
            
            // Agrupar por respons√°vel
            const escaladosMap = {};
            let [horas, minutos] = horaInicio.split(':').map(Number);
            
            liturgiaItens.forEach(item => {
                if (item.responsavel && !item.responsavel.startsWith('---') && item.responsavel !== 'Outro...') {
                    if (!escaladosMap[item.responsavel]) {
                        escaladosMap[item.responsavel] = {
                            nome: item.responsavel,
                            telefone: buscarTelefone(item.responsavel)
                        };
                    }
                }
            });
            
            const escalados = Object.values(escaladosMap);
            
            // Encontrar pr√≥ximo n√£o notificado com telefone
            const proximo = escalados.find(e => 
                e.telefone && !notificadosHoje[chave]?.[e.nome]
            );
            
            if (proximo) {
                notificarPessoa(proximo.nome);
            } else {
                const semTelefone = escalados.filter(e => !e.telefone);
                if (semTelefone.length > 0) {
                    showToast(`Todos notificados! ${semTelefone.length} sem telefone.`, true);
                } else {
                    showToast('Todos j√° foram notificados! üéâ');
                }
            }
        }
        
        // Limpar marca√ß√µes de notificados
        function limparNotificados() {
            const data = document.getElementById('dataCulto').value;
            const tipo = document.getElementById('tipoCulto').value;
            const chave = `${data}_${tipo}`;
            
            notificadosHoje[chave] = {};
            renderizarListaEscalados();
            showToast('Marca√ß√µes limpas!');
        }
        
        // ========================================
        // GERENCIAMENTO DE CONTATOS
        // ========================================
        
        // Renderizar lista de contatos para edi√ß√£o
        function renderizarListaContatos() {
            const container = document.getElementById('contatosList');
            
            // Pegar todos os respons√°veis √∫nicos (da lista + dos itens da liturgia)
            // Usar Map para evitar duplicatas case-insensitive
            const responsaveisMap = new Map();
            
            // Da lista padr√£o (prioridade - mant√©m o case original)
            responsaveis.forEach(r => {
                if (r && !r.startsWith('---') && r !== 'Outro...' && r !== '') {
                    const chave = r.toUpperCase();
                    if (!responsaveisMap.has(chave)) {
                        responsaveisMap.set(chave, r);
                    }
                }
            });
            
            // Dos itens da liturgia
            liturgiaItens.forEach(item => {
                if (item.responsavel && !item.responsavel.startsWith('---')) {
                    const chave = item.responsavel.toUpperCase();
                    if (!responsaveisMap.has(chave)) {
                        responsaveisMap.set(chave, item.responsavel);
                    }
                }
            });
            
            // Dos contatos j√° salvos (pode ter nomes adicionais)
            Object.keys(contatosResponsaveis).forEach(nome => {
                const chave = nome.toUpperCase();
                if (!responsaveisMap.has(chave)) {
                    responsaveisMap.set(chave, nome);
                }
            });
            
            // Converter para array e ordenar
            const listaOrdenada = Array.from(responsaveisMap.values()).sort();
            
            if (listaOrdenada.length === 0) {
                container.innerHTML = '<p style="color: #a0a0a0; text-align: center;">Nenhum respons√°vel cadastrado.</p>';
                return;
            }
            
            container.innerHTML = listaOrdenada.map(nome => {
                // Buscar telefone pelo nome ou varia√ß√µes de case
                let telefone = contatosResponsaveis[nome] || '';
                if (!telefone) {
                    // Tentar encontrar com case diferente
                    const chave = nome.toUpperCase();
                    for (const [n, t] of Object.entries(contatosResponsaveis)) {
                        if (n.toUpperCase() === chave) {
                            telefone = t;
                            break;
                        }
                    }
                }
                
                return `
                    <div class="contato-item">
                        <span class="contato-nome">${nome}</span>
                        <input type="tel" 
                               placeholder="(61) 99999-9999" 
                               value="${telefone}"
                               data-nome="${nome.replace(/"/g, '&quot;')}"
                               onchange="atualizarContato(this)">
                        <button class="btn-excluir-contato" onclick="excluirContato('${nome.replace(/'/g, "\\'")}')">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }
        
        // Adicionar novo contato
        function adicionarNovoContato() {
            const nome = document.getElementById('novoContatoNome').value.trim();
            const grupo = document.getElementById('novoContatoGrupo').value;
            const telefone = document.getElementById('novoContatoTelefone').value.trim();
            
            if (!nome) {
                showToast('Digite o nome do contato!', true);
                return;
            }
            
            if (!telefone) {
                showToast('Digite o telefone!', true);
                return;
            }
            
            // Verificar se j√° existe
            if (contatosResponsaveis[nome]) {
                showToast(`"${nome}" j√° est√° cadastrado!`, true);
                return;
            }
            
            // Adicionar ao cadastro de contatos
            contatosResponsaveis[nome] = telefone;
            
            // Adicionar √† lista de respons√°veis (se tiver grupo)
            if (grupo && grupo !== 'outro') {
                const grupoInfo = gruposDisponiveis.find(g => g.id === grupo);
                if (grupoInfo) {
                    const marcadorGrupo = `--- ${grupoInfo.nome} ---`;
                    let posicaoGrupo = responsaveis.indexOf(marcadorGrupo);
                    
                    if (posicaoGrupo > -1) {
                        // Encontrar fim do grupo
                        let posicaoFim = posicaoGrupo + 1;
                        while (posicaoFim < responsaveis.length && 
                               !responsaveis[posicaoFim].startsWith('---') && 
                               responsaveis[posicaoFim] !== 'Outro...') {
                            posicaoFim++;
                        }
                        
                        // Inserir em ordem alfab√©tica
                        let posicaoInserir = posicaoGrupo + 1;
                        while (posicaoInserir < posicaoFim && 
                               responsaveis[posicaoInserir].localeCompare(nome) < 0) {
                            posicaoInserir++;
                        }
                        
                        if (!responsaveis.includes(nome)) {
                            responsaveis.splice(posicaoInserir, 0, nome);
                            responsaveisAdicionados.push({ nome, grupo });
                        }
                    }
                }
            } else if (!responsaveis.includes(nome)) {
                // Adicionar antes de "Outro..."
                const outroIndex = responsaveis.indexOf('Outro...');
                if (outroIndex > -1) {
                    responsaveis.splice(outroIndex, 0, nome);
                }
                responsaveisAdicionados.push({ nome, grupo: 'outro' });
            }
            
            // Limpar formul√°rio
            document.getElementById('novoContatoNome').value = '';
            document.getElementById('novoContatoGrupo').value = '';
            document.getElementById('novoContatoTelefone').value = '';
            
            // Atualizar lista
            renderizarListaContatos();
            showToast(`"${nome}" adicionado com sucesso!`);
        }
        
        // Excluir contato
        function excluirContato(nome) {
            if (!confirm(`Excluir "${nome}" da lista de contatos?`)) {
                return;
            }
            
            // Remover do cadastro de contatos (e varia√ß√µes de case)
            const chave = nome.toUpperCase();
            const keysToDelete = [];
            
            for (const key of Object.keys(contatosResponsaveis)) {
                if (key.toUpperCase() === chave) {
                    keysToDelete.push(key);
                }
            }
            
            keysToDelete.forEach(key => delete contatosResponsaveis[key]);
            
            // Atualizar lista
            renderizarListaContatos();
            showToast(`"${nome}" removido! Clique em Salvar para confirmar.`);
        }
        
        // Atualizar contato temporariamente
        function atualizarContato(input) {
            const nome = input.dataset.nome;
            const telefone = input.value.trim();
            
            // Remover vers√µes antigas com case diferente
            const chave = nome.toUpperCase();
            for (const key of Object.keys(contatosResponsaveis)) {
                if (key.toUpperCase() === chave && key !== nome) {
                    delete contatosResponsaveis[key];
                }
            }
            
            if (telefone) {
                contatosResponsaveis[nome] = telefone;
            } else {
                delete contatosResponsaveis[nome];
            }
            
            // Auto-salvar ap√≥s 2 segundos de inatividade
            clearTimeout(window.autoSaveTimeout);
            window.autoSaveTimeout = setTimeout(() => {
                if (Object.keys(contatosResponsaveis).length > 0) {
                    contatosRef.set(contatosResponsaveis)
                        .then(() => {
                            console.log('Auto-save: contatos salvos');
                            showToast('Contato salvo automaticamente!');
                        })
                        .catch(err => console.error('Auto-save erro:', err));
                }
            }, 2000);
        }
        
        // Salvar contatos no Firebase (cadastro √∫nico - sincroniza com ministrantes)
        function salvarContatos() {
            // Verificar se h√° contatos para salvar
            const totalContatos = Object.keys(contatosResponsaveis).length;
            console.log('Salvando contatos:', totalContatos, contatosResponsaveis);
            
            if (totalContatos === 0) {
                showToast('Nenhum contato com telefone para salvar!', true);
                return;
            }
            
            showToast('Salvando contatos...');
            
            // Salvar em contatos_responsaveis
            contatosRef.set(contatosResponsaveis)
                .then(() => {
                    console.log('Contatos salvos com sucesso no Firebase!');
                    // Tamb√©m atualizar ministrantes no escala
                    sincronizarMinistrantes();
                    showToast(`${totalContatos} contato(s) salvo(s) com sucesso!`);
                })
                .catch(err => {
                    console.error('Erro ao salvar contatos:', err);
                    showToast('Erro ao salvar contatos: ' + err.message, true);
                });
        }
        
        // Sincronizar contatos com escala_ministracoes/ministrantes
        function sincronizarMinistrantes() {
            ministrantesRef.once('value').then(snapshot => {
                let ministrantes = snapshot.val() || [];
                let atualizado = false;
                
                // Atualizar telefones dos ministrantes existentes
                ministrantes = ministrantes.map(m => {
                    if (m && m.nome) {
                        const primeiroNome = extrairPrimeiroNome(m.nome);
                        
                        // Buscar telefone nos contatos
                        for (const [nome, telefone] of Object.entries(contatosResponsaveis)) {
                            if (extrairPrimeiroNome(nome) === primeiroNome) {
                                if (m.telefone !== telefone) {
                                    m.telefone = telefone;
                                    atualizado = true;
                                }
                                break;
                            }
                        }
                    }
                    return m;
                });
                
                if (atualizado) {
                    ministrantesRef.set(ministrantes).then(() => {
                        console.log('Ministrantes sincronizados');
                    });
                }
            }).catch(err => {
                console.log('Erro ao sincronizar ministrantes:', err);
            });
        }
        
        // Sincronizar com cadastro de ministrantes (Planejamento de Ministra√ß√µes)
        function sincronizarComAniversariantes() {
            showToast('Buscando telefones no Planejamento de Ministra√ß√µes...');
            
            ministrantesRef.once('value').then(snapshot => {
                const ministrantes = snapshot.val() || [];
                let atualizados = 0;
                
                if (ministrantes.length === 0) {
                    showToast('Nenhum ministrante encontrado no cadastro.', true);
                    return;
                }
                
                // Para cada respons√°vel, tentar encontrar no cadastro de ministrantes
                responsaveis.forEach(nomeResponsavel => {
                    if (!nomeResponsavel || nomeResponsavel.startsWith('---') || nomeResponsavel === 'Outro...') return;
                    
                    // Se j√° tem telefone cadastrado, pular
                    if (contatosResponsaveis[nomeResponsavel]) return;
                    
                    const primeiroNome = extrairPrimeiroNome(nomeResponsavel);
                    
                    // Buscar no cadastro de ministrantes
                    const ministrante = ministrantes.find(m => {
                        if (!m || !m.nome) return false;
                        const primeiroNomeMin = extrairPrimeiroNome(m.nome);
                        return primeiroNomeMin === primeiroNome;
                    });
                    
                    if (ministrante && ministrante.telefone) {
                        contatosResponsaveis[nomeResponsavel] = ministrante.telefone;
                        atualizados++;
                    }
                });
                
                // Tamb√©m buscar para os itens da liturgia atual
                liturgiaItens.forEach(item => {
                    if (!item.responsavel || item.responsavel.startsWith('---')) return;
                    if (contatosResponsaveis[item.responsavel]) return;
                    
                    const primeiroNome = extrairPrimeiroNome(item.responsavel);
                    
                    const ministrante = ministrantes.find(m => {
                        if (!m || !m.nome) return false;
                        const primeiroNomeMin = extrairPrimeiroNome(m.nome);
                        return primeiroNomeMin === primeiroNome;
                    });
                    
                    if (ministrante && ministrante.telefone) {
                        contatosResponsaveis[item.responsavel] = ministrante.telefone;
                        atualizados++;
                    }
                });
                
                if (atualizados > 0) {
                    renderizarListaContatos();
                    showToast(`${atualizados} telefone(s) encontrado(s)! Clique em Salvar para confirmar.`);
                } else {
                    showToast('Nenhum telefone novo encontrado. Verifique se os nomes correspondem.', true);
                }
                
            }).catch(err => {
                showToast('Erro ao buscar ministrantes: ' + err.message, true);
            });
        }

        // ========================================
        // GERENCIAMENTO DE MODELOS DE MENSAGEM
        // ========================================
        
        // Refer√™ncia Firebase para modelos de mensagem
        const modelosRef = database.ref('modelos_mensagem');
        
        // Modelos de mensagem (padr√£o + personalizados)
        let modelosMensagem = {
            'padrao': {
                nome: 'Escala√ß√£o Padr√£o',
                texto: `Paz do Senhor, {nome}! [EMOJI_MAOS]

Voc√™ est√° escalado(a) para o culto de *{tipoCulto}* no dia *{data}*:

[EMOJI_LISTA] *{atividade}*
[EMOJI_RELOGIO] Hor√°rio previsto: *{horario}*

Contamos com voc√™! Deus aben√ßoe! [EMOJI_MAOS_CIMA]

*Bispo Vanjivaldo e Pra K√©lia*
_Igreja de Deus √Åguas Claras - IDAC_`
            }
        };
        
        // Carregar modelos do Firebase
        function carregarModelos() {
            modelosRef.once('value').then(snapshot => {
                const dados = snapshot.val();
                if (dados) {
                    // Mesclar com o padr√£o (mant√©m o padr√£o sempre)
                    modelosMensagem = { ...modelosMensagem, ...dados };
                }
                atualizarSelectModelos();
                console.log('Modelos carregados:', Object.keys(modelosMensagem).length);
            }).catch(err => {
                console.log('Erro ao carregar modelos:', err);
            });
        }
        
        // Carregar modelos ao iniciar
        carregarModelos();
        
        // Atualizar o select de tipos de mensagem
        function atualizarSelectModelos() {
            const select = document.getElementById('tipoMensagemSelect');
            if (!select) return;
            
            select.innerHTML = Object.entries(modelosMensagem).map(([id, modelo]) => {
                return `<option value="${id}">${modelo.nome}</option>`;
            }).join('');
        }
        
        // Carregar tipo de mensagem selecionado
        function carregarTipoMensagem() {
            const select = document.getElementById('tipoMensagemSelect');
            const textarea = document.getElementById('mensagemTemplate');
            
            if (!select || !textarea) return;
            
            const tipoSelecionado = select.value;
            const modelo = modelosMensagem[tipoSelecionado];
            
            if (modelo) {
                textarea.value = modelo.texto;
            }
        }
        
        // Abrir modal de gerenciamento de mensagens
        function abrirModalMensagens() {
            renderizarListaModelos();
            document.getElementById('modalMensagens').classList.add('active');
        }
        
        // Renderizar lista de modelos
        function renderizarListaModelos() {
            const container = document.getElementById('modelosList');
            
            const modelos = Object.entries(modelosMensagem);
            
            if (modelos.length === 0) {
                container.innerHTML = '<p style="color: #a0a0a0; text-align: center;">Nenhum modelo cadastrado.</p>';
                return;
            }
            
            container.innerHTML = modelos.map(([id, modelo]) => {
                const isPadrao = id === 'padrao';
                return `
                    <div class="contato-item" style="flex-direction: column; align-items: stretch;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span class="contato-nome">${modelo.nome} ${isPadrao ? '(padr√£o)' : ''}</span>
                            ${!isPadrao ? `<button class="btn-excluir-contato" onclick="excluirModelo('${id}')">üóëÔ∏è</button>` : ''}
                        </div>
                        <textarea 
                            style="width: 100%; min-height: 80px; padding: 8px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: #fff; font-size: 0.85rem; resize: vertical;"
                            data-id="${id}"
                            onchange="atualizarModelo('${id}', this.value)"
                            ${isPadrao ? '' : ''}
                        >${modelo.texto}</textarea>
                    </div>
                `;
            }).join('');
        }
        
        // Adicionar novo modelo
        function adicionarNovoModelo() {
            const nome = document.getElementById('novoModeloNome').value.trim();
            const texto = document.getElementById('novoModeloTexto').value.trim();
            
            if (!nome) {
                showToast('Digite o nome do modelo!', true);
                return;
            }
            
            if (!texto) {
                showToast('Digite o texto da mensagem!', true);
                return;
            }
            
            // Gerar ID √∫nico
            const id = 'modelo_' + Date.now();
            
            // Adicionar ao objeto
            modelosMensagem[id] = {
                nome: nome,
                texto: texto
            };
            
            // Limpar formul√°rio
            document.getElementById('novoModeloNome').value = '';
            document.getElementById('novoModeloTexto').value = '';
            
            // Atualizar lista e select
            renderizarListaModelos();
            atualizarSelectModelos();
            
            showToast(`Modelo "${nome}" adicionado! Clique em Salvar para confirmar.`);
        }
        
        // Atualizar texto de um modelo
        function atualizarModelo(id, novoTexto) {
            if (modelosMensagem[id]) {
                modelosMensagem[id].texto = novoTexto;
            }
        }
        
        // Excluir modelo
        function excluirModelo(id) {
            if (id === 'padrao') {
                showToast('N√£o √© poss√≠vel excluir o modelo padr√£o!', true);
                return;
            }
            
            const nome = modelosMensagem[id]?.nome || id;
            
            if (!confirm(`Excluir o modelo "${nome}"?`)) {
                return;
            }
            
            delete modelosMensagem[id];
            
            renderizarListaModelos();
            atualizarSelectModelos();
            
            showToast(`Modelo "${nome}" removido! Clique em Salvar para confirmar.`);
        }
        
        // Salvar modelos no Firebase
        function salvarModelos() {
            // Salvar apenas os modelos personalizados (n√£o o padr√£o)
            const modelosParaSalvar = {};
            Object.entries(modelosMensagem).forEach(([id, modelo]) => {
                if (id !== 'padrao') {
                    modelosParaSalvar[id] = modelo;
                }
            });
            
            modelosRef.set(modelosParaSalvar)
                .then(() => {
                    atualizarSelectModelos();
                    showToast('Modelos salvos com sucesso!');
                })
                .catch(err => {
                    showToast('Erro ao salvar modelos: ' + err.message, true);
                });
        }
    </script>
</body>
</html>
